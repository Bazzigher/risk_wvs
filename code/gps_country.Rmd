---
title: "R Notebook"
output: html_notebook
---

---
title: "R Notebook"
output: html_notebook
---

#Load packages
```{r}
library(data.table)
library(tidyr)
library(haven)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(lmtest)
library(maps)
library(mapdata)
library(readxl)
library(ggrepel)
library(wordcloud)
```

#Add data GPS
```{r}
gps_data <- haven::read_dta("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/GPS_dataset_individual_level/individual_new.dta")

head(country_data)
```

# Clean the data from missing values
```{r}
# Clean the data by removing records with missing values
cleaned_data <- gps_data %>%
  drop_na(country, isocode, risktaking, gender, age)

# Calculate the number of records removed per variable
records_removed_per_variable <- colSums(is.na(gps_data)) - colSums(is.na(cleaned_data))

# Display the cleaned data
cleaned_data

# Display the number of records removed per variable
records_removed_per_variable
```

# List of all variable
```{r}
# List all variables
variable_list <- names(cleaned_data) 

# Display the list of variables
print(variable_list)
```

############################# Calculate Z-Score for Age per Country
```{r}
cleaned_data <- cleaned_data %>%
  group_by(country) %>%
  mutate(z_score_age = scale(age))

# Display the new column with Z-Scores per Country
head(cleaned_data)
```

#select only the variables of interest
```{r}
cleaned_data <- cleaned_data %>%
  select(country, isocode, ison, risktaking, gender, z_score_age, age)
cleaned_data
```

# Add Hardship-list
```{r}
# Installiere und lade die benötigten Bibliotheken (falls nicht bereits geschehen)
if (!requireNamespace("data.table", quietly = TRUE)) {
  install.packages("data.table")
}
library(data.table)
if (!requireNamespace("tidyr", quietly = TRUE)) {
  install.packages("tidyr")
}
library(tidyr)
if (!requireNamespace("haven", quietly = TRUE)) {
  install.packages("haven")
}
library(haven)
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}
library(dplyr)

# Lade die "Hardship_complete.xlsx"-Datei
excel_path <- "/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/Hardship/Hardship_complete.xlsx"
hardship_data_complete <- read_excel(excel_path)

# Zeige das aktualisierte dataset an
head(hardship_data_complete)
```

#################################################################
#################################################################
#################################################################
#################################################################
############################# Calculate Z-Score for Age, mean_homicide, gini_income, Infant_mortality and life_expect per Country
```{r}
hardship_data_complete
# Z-standardize specific columns
hardship_data_complete$gdp <- scale(hardship_data_complete$gdp)
hardship_data_complete$gini_income <- scale(hardship_data_complete$gini_income)
hardship_data_complete$Infant_mortality <- scale(hardship_data_complete$Infant_mortality)
hardship_data_complete$life_expect <- scale(hardship_data_complete$life_expect)
hardship_data_complete$mean_homicide <- scale(hardship_data_complete$mean_homicide)
# Print the z-standardized data
print(hardship_data_complete)
hardship_data_complete <- hardship_data_complete %>%
  mutate(hardship = (mean_homicide + gdp + Infant_mortality + life_expect + gini_income) / 5)
hardship_data_complete
```


# Add Intercept and slope_age to the gps_country 
```{r}
# Führe einen left_join basierend auf der "country"-Spalte durch
cleaned_data <- left_join(cleaned_data, hardship_data_complete, by = "country")
cleaned_data
```


# Create a new column "age_group" with the age categories
```{r}
cleaned_data$agecat <- cut(
  cleaned_data$age,
  breaks = c(15, 20, 30, 40, 50, 60, 70, 80, Inf), # The category boundaries
  labels = c("15-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+"), # The category labels
  right = FALSE # Left end (inclusive), right end (exclusive)
)

# Display the new column
head(cleaned_data)
```
# Calculate the the mean and add column
```{r}
# Calculate mean values for risktaking, gender, and age per country
country_means <- cleaned_data %>%
  group_by(country) %>%
  summarize(
    mean_risktaking = mean(risktaking, na.rm = TRUE),
    mean_gender = mean(gender, na.rm = TRUE),
    mean_age = mean(age, na.rm = TRUE), 
    mean_z_score_age = mean(age, na.rm = TRUE),
  )

# Merge mean values back to the original dataset
cleaned_data <- merge(cleaned_data, country_means, by = "country", all.x = TRUE)

# Display the updated dataset
head(cleaned_data)
```


#select only the variables of interest
```{r}
gps_country <- cleaned_data %>%
  select(country, isocode.x, ison, risktaking, mean_risktaking, gender, z_score_age, mean_z_score_age, hardship
)
gps_country
```

# Calculate mean values for risktaking, gender, and age per country
```{r}
#select only the variables of interest
gps_country <- cleaned_data %>%
  group_by(country) %>%
  summarize(
    isocode = first(isocode.x),
    ison = first(ison),
    mean_risktaking = mean(risktaking, na.rm = TRUE),
    mean_gender = mean(gender, na.rm = TRUE),
    mean_age = mean(z_score_age, na.rm = TRUE),
    hardship = first(hardship)
  ) %>%
  ungroup()

gps_country
```

# Regression table
```{r}
# Führe die lineare Regression durch
regression_model <- lm(risktaking ~ z_score_age + gender, data = cleaned_data)

# Extrahiere die Koeffizienten der Regression
coefficients <- summary(regression_model)$coefficients

# Extrahiere den Intercept und die Slopes
intercept <- coefficients["(Intercept)", "Estimate"]
slope_age <- coefficients["z_score_age", "Estimate"]
slope_gender <- coefficients["gender", "Estimate"]

# Füge die Informationen zur Regressionstabelle dem gps_country-Datensatz hinzu
gps_country <- gps_country %>%
  mutate(
    intercept = intercept,
    slope_age = slope_age,
    slope_gender = slope_gender
  )

# Zeige den aktualisierten gps_country-Datensatz an
head(gps_country)
```


########
# Add Intercept and slope_age to the gps_country 
```{r}
# Führe einen left_join basierend auf der "country"-Spalte durch
gps_country <- left_join(gps_country, regression_results_gps, by = "country")
gps_country
```

#######################################################################################################################
#######################################################################################################################
# Descriptive 

# Number of courtries after data cleaning
```{r}
# Determine the number of different countries
number_of_countries <- length(unique(cleaned_data$country))

# Display the number of different countries
number_of_countries
```

###########
##########
##########
#CODE FOR THE PRESENTATION 
###########
##########
##########

# Worldmap of the recorded countries
```{r}
world_map <- map_data("world") # Create a world map with country borders

recorded_countries <- unique(cleaned_data$country) # Get the list of recorded countries from your cleaned_data

world_map$recorded <- ifelse(world_map$region %in% recorded_countries, "Recorded", "Not Recorded") # Create a new variable indicating whether a country has been recorded or not

# Plot the world map with recorded countries highlighted
ggplot(world_map, aes(x = long, y = lat, group = group, fill = recorded)) +
  geom_polygon(color = "white") +
  scale_fill_manual(values = c("Recorded" = "darkblue", "Not Recorded" = "lightgrey"), guide = "none") +  # Set guide to "none" to remove the legend
  theme_void() +
  labs(title = "GPS", fill = "Status") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))  # Remove legend and center the title

```
#############################################################
#############################################################
# All about the age
```{r}
# Age Range
age_min <- min(cleaned_data$age, na.rm = TRUE)
age_max <- max(cleaned_data$age, na.rm = TRUE)

# Average Age
average_age <- mean(cleaned_data$age, na.rm = TRUE)

# Median Age
median_age <- median(cleaned_data$age, na.rm = TRUE)

# Display the age statistics
cat("Age Range: ", age_min, " to ", age_max, "\n")
cat("Average Age: ", average_age, "\n")
cat("Median Age: ", median_age, "\n")
```

# Number of participants in each age category
```{r}
# number of participants in each age category
agecat_counts <- table(cleaned_data$agecat)

# Display the number of participants in the age categories
print(agecat_counts)
```


###########
###########
###########
FOR PRESENTATION
############################# 


# Risk vs age with color-coded gender per Country
```{r}
# Skalierung des Z-Scores für das Alter anpassen
cleaned_data$z_score_age_scaled <- 15 * cleaned_data$z_score_age + 42

# Risk vs age with color-coded gender per Country
ggplot(cleaned_data, aes(z_score_age_scaled, risktaking, color = factor(gender))) +
  geom_point(size = 0.1) +  
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 42, linetype = "dashed", color = "black", size = 1) +  # Vertikale Linie für den Mittelwert
  scale_color_manual(values = c("blue", "red"), labels = c("Male", "Female")) +
  labs(color = "Gender", x = "Age", y = "Risk Taking") +  # Hier wurden die Achsentitel geändert
  scale_x_continuous(breaks = seq(0, 100, by = 15), limits = c(0, 100)) +  # Anpassung der Intervalle auf der X-Achse
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```




```{r}
# Scatter plot with labels
ggplot(gps_country, aes(x = hardship, y = intercept, label = isocode)) +
  geom_point(size = 3, position = position_jitter(width = 0.05, height = 0.05)) +  # Jitter für bessere Verteilung
  geom_text_repel(
    aes(label = isocode),
    box.padding = 1,  # Größerer box.padding-Wert
    point.padding = 0.5,  # Größerer point.padding-Wert
    force = 5,
    min.segment.length = 0.5,  # Größerer min.segment.length-Wert
    max.overlaps = 100  # Erhöhen Sie max.overlaps, um mehr Überlappungen zu erlauben
  ) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(title = "",
       x = "Hardship",
       y = "Risk Taking") +
  theme_minimal() +
  expand_limits(x = c(-1, 1.5), y = c(-1, 1.5))  # Festlegen der Achsenlimits
```



# Age vs. hardship across countries
```{r}
# Skalierung des Z-Scores für das Alter anpassen
cleaned_data$z_score_age_scaled <- 15 * cleaned_data$z_score_age + 42# Risktaking vs. hardship across countries
ggplot(cleaned_data, aes(x = scale(hardship), y = scale(mean_z_score_age))) +
  geom_point(color = "black", size = 1.5) +  # Schwarze Punkte der Größe 1,5
  geom_text(aes(label = isocode), vjust = -0.5, hjust = 0.5, size = 3, color = "black", position = position_nudge(y = 0.02)) +  # Isocodes mit kleinen Linien
  labs(title = "Hardship and Age across Countries GPS",
       x = "Hardship", y = "Age") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
```


```{r}
# Convert 'hardship' to numeric
cleaned_data$hardship <- as.numeric(as.character(cleaned_data$hardship))

# Scatter plot with labels
scatter_plot <- ggplot(cleaned_data, aes(x = hardship, y = mean_risktaking, label = isocode)) +
  geom_point(size = 3) +
  geom_text_repel(
    aes(label = isocode),
    box.padding = 0.5,
    point.padding = 0.1,
    force = 5
  ) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(title = "GPS",
       x = "Hardship",
       y = "Risk Taking") +
  theme_minimal() +
  xlim(c(0, 1.2)) +
  ylim(c(0, 1.2)) +
  coord_fixed()

# Annotate with word cloud
wordcloud_plot <- wordcloud(words = cleaned_data$isocode, freq = rep(1, nrow(cleaned_data)), scale = c(2, 0.5))

# Arrange plots side by side
grid.arrange(scatter_plot, wordcloud_plot, ncol = 2)
```

```{r}
# Coefficients for age-effect
age_coefficients <- coef(model_age)

# Coefficients for gender-effect
gender_coefficients <- coef(model_gender)

```

```{r}

# Scatterplot for age-effect with scaled x-axis
ggplot(cleaned_data, aes(x = mean_z_score_age, y = hardship)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +
  labs(title = "Scatterplot of Hardship vs Age",
       x = "Age", y = "Hardship") +
  scale_x_continuous(
    breaks = seq(0, 100, by = 15),  # Anpassung der Intervalle auf der X-Achse
    limits = c(0, 100),
    labels = seq(42 - 15 * 3, 42 + 15 * 3, by = 15)  # Labels entsprechend der SD um den Mittelwert
  ) +
  theme_minimal()


```


################################################################################################################################################################################################################################################


###########
###########
###########
Laura has to rewrite the code --> Table already included with the lm

```{r}
# Fit das Modell mit "age"
model_gender <- lm(risktaking ~ age + gender, data = cleaned_data)

# Intercept and Slope for age
intercept_age <- coef(model)["(Intercept)"]
slope_age <- coef(model)["age"]

summary(model)
```

###########
###########
###########
Laura has to rewrite the code --> Table already included with the lm


# Create a table with the following information: country, isocode, n (count of participants), female percentage (%), mean age, age range, and risktaking

### Four loup 
Group by country
mutate intercept 
run and save intercept model 
```{r}
# Group the data by country
table_data <- gps_data %>%
  group_by(country, isocode) %>%
  summarize(
    n = n(),
    female_percentage = mean(gender == 1) * 100,
    mean_age = mean(age, na.rm = TRUE),
    age_range = paste(min(age, na.rm = TRUE), "-", max(age, na.rm = TRUE)),
    mean_risktaking = mean(risktaking, na.rm = TRUE)
  )

# Intercept and slope for age
intercept_age <- 0.5759701
slope_age <- -0.0137902

# Intercept and slope for gender
intercept_gender <- 0.124666 
slope_gender <- -0.227338 

# Add the intercept and slope information to the table
table_data <- table_data %>%
  mutate(
    intercept_age = intercept_age,
    slope_age = slope_age,
    intercept_gender = intercept_gender,
    slope_gender = slope_gender,
  )

# Display the updated table
table_data
```


#############################################
#############################################



#Preparing for linear regression
```{r}
# Check for missing values in 'Country' and 'Risktaking' columns
missing_country <- anyNA(cleaned_data$country)
missing_risktaking <- anyNA(cleaned_data$risktaking)

# Print the results
cat("Missing values in 'Country': ", missing_country, "\n")
cat("Missing values in 'Risktaking': ", missing_risktaking, "\n")

```


```{r}
# Clean the data by removing records with missing values
cleaned_data <- gps_data %>%
  drop_na(country, risktaking, age)

# Split the data by country and perform linear regression for each country
regression_results <- cleaned_data %>%
  group_by(country) %>%
  do(model = lm(risktaking ~ age, data = .)) %>%
  summarize(
    country = first(country),
    intercept = summary(model)$coefficients[1],
    slope = summary(model)$coefficients[2],
    r_squared = summary(model)$r.squared
  )

# Display regression results for each country
print(regression_results)
```


# analyze the results by using "Balkendiagramm"
###### what does 0 mean? // centered age = mean age of the sample
```{r}
ggplot(data = regression_results, aes(x = country, y = intercept)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Intercepts for Risktaking by Country", x = "Country", y = "Intercept Value") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
# View the countries with intercept values over 0.75
```{r}
high_intercept_countries <- subset(regression_results, intercept > 0.75)

# View the countries with intercept values over 0.75
print(high_intercept_countries)
```


# Scatterplots for 'high_intercept_countries' contains the top 17 countries
```{r}
# Create scatterplots with regression lines for countries with intercept > 0.75
plots <- lapply(high_intercept_countries$country, function(country) {
  p <- ggplot(subset(cleaned_data, country == country), aes(x = age, y = risktaking, color = factor(gender))) +
    geom_point(size = 0.5) +
    geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
    labs(title = paste("Linear Regression for", country),
         subtitle = paste("Intercept:", round(high_intercept_countries$intercept[high_intercept_countries$country == country], 2)),
         color = "Gender") +
    scale_color_manual(values = c("0" = "blue", "1" = "red"), labels = c("Male", "Female"))
  print(p)
})

# Save the plots in a directory
dir.create("individual_country_plots", showWarnings = FALSE)
setwd("individual_country_plots")

for (i in seq_along(plots)) {
  filename <- paste0("plot_", i, ".png")
  ggsave(filename, plot = plots[[i]], width = 8, height = 6)
}

# Switch back to the original working directory
setwd("..")

print("Individual plots for countries with intercept > 0.75 are saved in the 'individual_country_plots' directory.")

```

# Scatterplots for 'high_intercept_countries' contains the top 17 countries
```{r}
plots <- lapply(high_intercept_countries$country, function(country) {
  p <- ggplot(subset(cleaned_data, country == country), aes(x = ranking.x, y = risktaking, color = factor(gender))) +
    geom_point(size = 0.5) +
    geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
    labs(title = paste("Linear Regression for", country),
         subtitle = paste("Intercept:", round(high_intercept_countries$intercept[high_intercept_countries$country == country], 2)),
         color = "Gender") +
    scale_color_manual(values = c("0" = "blue", "1" = "red"), labels = c("Male", "Female"))
  print(p)
})

# Save the plots in a directory
dir.create("individual_country_plots", showWarnings = FALSE)
setwd("individual_country_plots")

for (i in seq_along(plots)) {
  filename <- paste0("plot_", i, ".png")
  ggsave(filename, plot = plots[[i]], width = 8, height = 6)
}

# Switch back to the original working directory
setwd("..")

print("Individual plots for countries with intercept > 0.75 are saved in the 'individual_country_plots' directory.")
```

# Create scatterplots with regression lines for individual countries
```{r}
# Examples for countries
regression_results <- data.frame(
  country = c("Algeria", "Argentina", "Austria"),
  intercept = c(0.92053422, 0.51698822, 0.42606684),
  slope = c(-0.0146641801, -0.0115569623, -0.0108763042),
  r_squared = c(5.232529e-02, 5.638271e-02, 3.539810e-02	)
)

# Create scatterplots with regression lines for each country
plots <- lapply(seq_len(nrow(regression_results)), function(i) {
  country <- regression_results$country[i]
  intercept <- regression_results$intercept[i]
  slope <- regression_results$slope[i]
  r_squared <- regression_results$r_squared[i]
  
  p <- ggplot(subset(cleaned_data, country == country), aes(x = age, y = risktaking)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +
    labs(title = paste("Linear Regression for", country),
         subtitle = paste("Intercept:", round(intercept, 2),
                           "Slope:", round(slope, 2),
                           "R-squared:", round(r_squared, 2)))
  print(p)
})

# Save the plots in a directory
dir.create("individual_country_plots", showWarnings = FALSE)
setwd("individual_country_plots")

for (i in seq_along(plots)) {
  filename <- paste0("plot_", i, ".png")
  ggsave(filename, plot = plots[[i]], width = 8, height = 6)
}

# Switch back to the original working directory
setwd("..")

print("Individual plots are saved in the 'individual_country_plots' directory.")
```

# Scatterplot with include both individual country regression lines and an overall regression line
```{r}
# Calculate the overall regression line
overall_lm <- lm(risktaking ~ age, data = cleaned_data)

# Create a scatterplot with separate regression lines for each country
# and an overall regression line
ggplot(cleaned_data, aes(x = age, y = risktaking, color = country)) +
  geom_point(size = 0.5) +                      # Adjust point size
  geom_smooth(method = "lm", se = FALSE, size = 0.5) + # Solid line for individual countries
  geom_abline(intercept = coef(overall_lm)[1], slope = coef(overall_lm)[2], 
              color = "black", size = 1) + # Add the overall regression line in red
  labs(title = "Scatterplot with Regression Lines for risktaking and age by Country", 
       x = "Age", y = "Risktaking") +
  theme(legend.position = "bottom",          # Move the legend below the graph
        legend.key.size = unit(0.1, "in"))  # Adjust the size of the legend key
```



#################################################################################################################################################################
# Combined List of all 3 files

# Prepare Wave 5
```{r}
# Load the data
WV5_data <- readRDS("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/WV6_dataset_wave_5_6/F00007944-WV5_Data_R_v20180912.rds") # Data of Wave 5

#rename the variables
WV5_data <- WV5_data_df %>%
  rename(sex = V235, age = V237, country = V2, wave = V1, risktaking = V86)
WV5_data

#select only the variables of interest
WV5_data <- WV5_data %>%
  select(sex, age, country, wave, risktaking)
WV5_data

#decode the country names 
countrynames = read.csv("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/WV6_dataset_wave_5_6/countrynames.txt", header=FALSE,as.is=TRUE)
colnames(countrynames) = c("code", "name")
WV5_data$country_lab = countrynames$name [match(WV5_data$country, countrynames$code)]
table(WV5_data$country_lab)
WV5_data
```

# Prepare Wave 6
```{r}
#Read Dataset (Wave 6)
WV6_data <- load("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/WV6_dataset_wave_5_6/WV6_Data_R_v20201117.rdata") 
WV6_data <- WV6_Data_R_v20201117 
print(WV6_data)
```

#rename variables in Wave 6
```{r}
WV6_data <- WV6_data %>%
  rename(wave = V1, sex = V240, age = V242,country = V2, risktaking = V76)

#select only the variables of interest
WV6_data <- WV6_data %>%
  select(wave, sex, age, country, sex,risktaking)
WV6_data
```
#decode daraset (Wave 6)
```{r}
countrynames = read.csv("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/WV6_dataset_wave_5_6/countrynames.txt", header=FALSE,as.is=TRUE)
colnames(countrynames) = c("code", "name")
WV6_data$country_lab = countrynames$name [match(WV6_data$country, countrynames$code)]
table(WV6_data$country_lab)
WV6_data
```
# Prepare GPS dataset (cleaned_data)
```{r}
# Rename "Country" in "country_lab"
print(colnames(cleaned_data))
```

#combine the 2 dataset (Wave 6 + Wave 5)
```{r}
WV5_data
WV6_data
data = rbind(WV5_data, WV6_data)
data

#number of countries

length(unique(data$country_lab))
```


# Merge the datasets based on common variables
```{r}
# Find common countries between the two datasets
common_countries <- intersect(data$country_lab, cleaned_data$country)

# Display the common countries
print(common_countries)

```

# Find countries in "data" but not in "cleaned_data"
```{r}
countries_only_in_data <- setdiff(data$country_lab, cleaned_data$country)

# Find countries in "cleaned_data" but not in "data"
countries_only_in_cleaned_data <- setdiff(cleaned_data$country, data$country_lab)

# Display the results
cat("Countries only in 'data':", countries_only_in_data, "\n")
cat("Countries only in 'cleaned_data':", countries_only_in_cleaned_data, "\n")
```



