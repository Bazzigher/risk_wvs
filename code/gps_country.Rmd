---
title: "R Notebook"
output: html_notebook
---

---
title: "R Notebook"
output: html_notebook
---

#Load packages
```{r}
library(data.table)
library(tidyr)
library(haven)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(lmtest)
library(maps)
library(mapdata)
library(readxl)
library(ggrepel)
library(wordcloud)
```

#Add data GPS
```{r}
gps_data <- haven::read_dta("/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/GPS_dataset_individual_level/individual_new.dta")

head(country_data)
```

# Clean the data from missing values
```{r}
# Clean the data by removing records with missing values
cleaned_data <- gps_data %>%
  drop_na(country, isocode, risktaking, gender, age)

# Calculate the number of records removed per variable
records_removed_per_variable <- colSums(is.na(gps_data)) - colSums(is.na(cleaned_data))

# Display the cleaned data
cleaned_data

# Display the number of records removed per variable
records_removed_per_variable
```

############################# Calculate Z-Score for Age per Country
```{r}
cleaned_data <- cleaned_data %>%
  group_by(country) %>%
  mutate(z_score_age = scale(age))

# Display the new column with Z-Scores per Country
head(cleaned_data)
```

#select only the variables of interest
```{r}
cleaned_data <- cleaned_data %>%
  select(country, isocode, ison, risktaking, gender, z_score_age, age)
cleaned_data
```
####################################################################
####################################################################
# Add Hardship-list
```{r}
if (!requireNamespace("data.table", quietly = TRUE)) {
  install.packages("data.table")
}
library(data.table)
if (!requireNamespace("tidyr", quietly = TRUE)) {
  install.packages("tidyr")
}
library(tidyr)
if (!requireNamespace("haven", quietly = TRUE)) {
  install.packages("haven")
}
library(haven)
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}
library(dplyr)

# Lade die "Hardship_complete.xlsx"-Datei
excel_path <- "/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/Hardship/Hardship_complete.xlsx"
hardship_data_complete <- read_excel(excel_path)

# Zeige das aktualisierte dataset an
hardship_data_complete
```

# Umwandlung der relevanten Spalten in numerische Werte
```{r}
# Laden Sie das erforderliche Paket
library(dplyr)

# Auswahl nur numerischer Spalten (ohne 'country')
numerical_data <- select_if(hardship_data_complete, is.numeric)

# Konvertieren Sie die Daten in numerische Werte
numerical_data <- sapply(numerical_data, as.numeric)

# Funktion zur Erstellung von Histogrammen für jedes Item
create_histograms <- function(data) {
  par(mfrow = c(2, 3))  # Festlegen der Anordnung der Histogramme
  for (i in 1:ncol(data)) {
    hist(data[, i], main = names(data)[i], xlab = names(hardship_data_complete)[i], ylab = "Frequency", col = "lightblue")
  }
}

# Anwenden der Funktion auf die numerischen Spalten
create_histograms(numerical_data)

```


# log transform
```{r}
hardship_data_complete$mean_homicide=log(hardship_data_complete$mean_homicide)
hardship_data_complete$gdp=log(hardship_data_complete$gdp)
hardship_data_complete$Infant_mortality=log(hardship_data_complete$Infant_mortality)
hardship_data_complete$life_expect=log(hardship_data_complete$life_expect)
hardship_data_complete$gini_income=log(hardship_data_complete$gini_income)
```

# changing variables into the same direction
```{r}
# Reverse Codierung
hardship_data_complete$mean_homicide=scale(hardship_data_complete$mean_homicide)
hardship_data_complete$gdp=scale(-hardship_data_complete$gdp)
hardship_data_complete$Infant_mortality=scale(hardship_data_complete$Infant_mortality)
hardship_data_complete$life_expect=scale(-hardship_data_complete$life_expect)
hardship_data_complete$gini_income=scale(hardship_data_complete$gini_income)
hardship_data_complete
```

# create a hardship index
```{r}
hardship_data_complete$hardship=(hardship_data_complete$mean_homicide+hardship_data_complete$gdp+hardship_data_complete$gini_income+hardship_data_complete$life_expect+hardship_data_complete$Infant_mortality)/5

hardship_data_complete
```


#select only the variables of interest
```{r}
hardship_data_complete <- hardship_data_complete %>%
  select(country, isocode, hardship)
hardship_data_complete
```

#table intercept and slope 
```{r}
#table intercept and slope 
regression_results_gps <- cleaned_data %>%
  group_by(country) %>%
  do(model = lm(risktaking ~ z_score_age + gender, data = .)) %>%
  summarize(
    country = first(country),
    intercept = coef(summary(model))[1, 1],
    slope_age = coef(summary(model))[2, 1],
    slope_gender = coef(summary(model))[3, 1]
  )

regression_results_gps
```

```{r}
# Führe einen left_join basierend auf der "country"-Spalte durch
regression_gps <- left_join(regression_results_gps, hardship_data_complete %>% select(country,isocode, hardship), by = "country")
regression_gps
```

```{r}
# Calculate mean values for intercept, slope_age, slope_gender, und hardship pro country
gps_regression <- regression_gps %>%
  group_by(country, isocode) %>%
  summarize(
    mean_intercept = mean(intercept, na.rm = TRUE),
    mean_slope_age = mean(slope_age, na.rm = TRUE),
    mean_slope_gender = mean(slope_gender, na.rm = TRUE),
    mean_hardship = mean(hardship, na.rm = TRUE)
  )

# Display the mean values per country
print(gps_regression)
```


###########
##########
##########
#CODE FOR THE PRESENTATION 
###########
##########
##########

# Worldmap of the recorded countries
```{r}
world_map <- map_data("world") # Create a world map with country borders

recorded_countries <- unique(cleaned_data$country) # Get the list of recorded countries from your cleaned_data

world_map$recorded <- ifelse(world_map$region %in% recorded_countries, "Recorded", "Not Recorded") # Create a new variable indicating whether a country has been recorded or not

# Plot the world map with recorded countries highlighted
ggplot(world_map, aes(x = long, y = lat, group = group, fill = recorded)) +
  geom_polygon(color = "white") +
  scale_fill_manual(values = c("Recorded" = "darkblue", "Not Recorded" = "lightgrey"), guide = "none") +  # Set guide to "none" to remove the legend
  theme_void() +
  labs(title = "GPS", fill = "Status") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))  # Remove legend and center the title

```
#############################################################
#############################################################
# All about the age
```{r}
# Age Range
age_min <- min(cleaned_data$age, na.rm = TRUE)
age_max <- max(cleaned_data$age, na.rm = TRUE)

# Average Age
average_age <- mean(cleaned_data$age, na.rm = TRUE)

# Median Age
median_age <- median(cleaned_data$age, na.rm = TRUE)

# Display the age statistics
cat("Age Range: ", age_min, " to ", age_max, "\n")
cat("Average Age: ", average_age, "\n")
cat("Median Age: ", median_age, "\n")
```

###########
###########
###########
FOR PRESENTATION
############################# 


# Risk vs age with color-coded gender per Country
```{r}
# Skalierung des Z-Scores für das Alter anpassen
cleaned_data$z_score_age_scaled <- 15 * cleaned_data$z_score_age + 42

# Risk vs age with color-coded gender per Country
ggplot(cleaned_data, aes(z_score_age_scaled, risktaking, color = factor(gender))) +
  geom_point(size = 0.1) +  
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 42, linetype = "dashed", color = "black", size = 1) +  # Vertikale Linie für den Mittelwert
  scale_color_manual(values = c("blue", "red"), labels = c("Male", "Female")) +
  labs(color = "Gender", x = "Age", y = "Risk Taking") +  # Hier wurden die Achsentitel geändert
  scale_x_continuous(breaks = seq(0, 100, by = 15), limits = c(0, 100)) +  # Anpassung der Intervalle auf der X-Achse
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```

#################
# Hardship and intercept (Risk Taking)
```{r}
# Scatter plot with labels
ggplot(gps_regression, aes(x = mean_hardship, y = mean_intercept, label = isocode)) +
  geom_point(size = 3) +
  geom_text_repel(
    aes(label = isocode),
    box.padding = 0.5,
    point.padding = 0.1,
    force = 5
  ) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(x = "Hardship",
       y = "Risk Taking") +
  theme_minimal() +
  scale_y_continuous(limits = c(-0.74, 1)) +  # Hier werden die Limits für die Y-Achse festgelegt
    scale_x_continuous(limits = c(-1, 1.5)) +  # Hier werden die Limits für die Y-Achse festgelegt
  coord_fixed(1)
```

# Hardship and mean_slope_age (Age)
```{r}
ggplot(gps_regression, aes(x = mean_hardship, y = mean_slope_age, label = isocode)) +
  geom_point(size = 3) +
  geom_text_repel(
    aes(label = isocode),
    box.padding = 0.5,
    point.padding = 0.1,
    force = 5
  ) +

  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(x = "Hardship",
       y = "Age Effect") +
  theme_minimal() +
  coord_fixed(ratio = 5)  # Adjust the ratio to achieve the desired square format
```

# Hardship and mean_slope_age (Age) mit R²-Wert
```{r}
# Regressionstabelle
regression_table <- regression_results_gps %>%
  left_join(hardship_data_complete %>% select(country, isocode, hardship), by = "country") %>%
  mutate_if(is.numeric, round, 3)  # Runde numerische Werte auf drei Dezimalstellen

# Anzeige der Ergebnisse
print(regression_table)
```

# Correlation Hardship und Risk Taking
```{r}
# Entferne Zeilen mit fehlenden Werten in den relevanten Spalten
cleaned_regression <- gps_regression %>%
  drop_na(mean_hardship, mean_intercept)

# Berechne die Korrelation erneut
correlation <- cor(cleaned_regression$mean_hardship, cleaned_regression$mean_intercept)

# Zeige die Korrelation an
print(paste("Correlation Hardship und Risk Taking:", correlation))
```

# Correlation Hardship und Age
```{r}
# Entferne Zeilen mit fehlenden Werten in den relevanten Spalten
cleaned_regression <- gps_regression %>%
  drop_na(mean_hardship, mean_slope_age)

# Berechne die Korrelation erneut
correlation <- cor(cleaned_regression$mean_hardship, cleaned_regression$mean_slope_age)

# Zeige die Korrelation an
print(paste("Correlation Hardship und age:", correlation))
```

