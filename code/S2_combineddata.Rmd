---
title: "S2_combineddata"
output: html_document
date: "2024-05-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set path Cristina: ONLY USE FOR CRISTINA
```{r}
base_path <- "/Users/cristinacandido/Documents/Github/risk_wvs/data/"
```

# Set path Laura: ONLY USE FOR LAURA 
```{r}
base_path <- "/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/Data_S2/"
```

```{r}
library(ggplot2)
library(lme4)
library(dplyr)
```


# Load data GPS & WVS 
```{r}
merged_data = read.csv(paste0(base_path, "data_combined.csv"), header=TRUE,as.is=TRUE)
head(merged_data)

summary(merged_data$age)  # Check the age variable
```
# Demografics
```{r}
# Anzahl der einzigartigen Länder im Datensatz ermitteln
num_countries <- length(unique(merged_data$country))

# Anzahl der Länder ausgeben
print(num_countries)
```


```{r}
library(dplyr)

# Gruppieren der Daten nach Land und Geschlecht und Zählen der Teilnehmer
participant_counts <- merged_data %>%
  group_by(country, gender) %>%
  summarise(participant_count = n())

# Gruppieren der Daten nach Land und Zählen der Gesamtanzahl der Teilnehmer pro Land
total_counts <- participant_counts %>%
  group_by(country) %>%
  summarise(total_participants = sum(participant_count))

# Filtern der Daten, um nur Frauen zu zählen
female_counts <- participant_counts %>%
  filter(gender == 0) %>%
  rename(female_count = participant_count) %>%
  select(country, female_count)

# Filtern der Daten, um nur Männer zu zählen
male_counts <- participant_counts %>%
  filter(gender == 1) %>%
  rename(male_count = participant_count) %>%
  select(country, male_count)

# Zusammenführen der Informationen zu einer Tabelle
participant_table <- merge(female_counts, male_counts, by = "country", all = TRUE)

# Zusammenführen der Gesamtanzahl von Teilnehmern pro Land
participant_table <- merge(participant_table, total_counts, by = "country", all = TRUE)

# Benennung der Spalten
names(participant_table) <- c("country", "female_count", "male_count", "total_participants")

# Fehlende Werte mit 0 füllen
participant_table[is.na(participant_table)] <- 0

# Anzeigen der Tabelle
print(participant_table)
```

```{r}
# Imputation von fehlenden Werten im hardship_index mit dem Median
median_hardship_index <- median(merged_data$hardship_index, na.rm = TRUE)
merged_data$hardship_index[is.na(merged_data$hardship_index)] <- median_hardship_index
```



# Model1 
```{r}
model1_combined = lmer(risktaking ~ 1 + age_scale + gender + (1 + age_scale + gender|country),data = merged_data, control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary_model1_combined=summary(model1_combined)
summary_model1_combined
```


# Model2
```{r}
model2_combined <- lmer(risktaking ~ 1 + age_scale * hardship_index + 
                    gender * hardship_index + 
                    (1 + age_scale | country),
                data = merged_data,control=lmerControl(optCtrl=list(maxfun=100000),optimizer="bobyqa"),REML = FALSE)

summary_model2_combined = summary(model2_combined) 

summary_model2_combined
```


```{r}
# Überprüfe die Modellspezifikationen für beide Modelle
print(summary(model1_combined))
print(summary(model2_combined))
```


```{r}
anova(model1_combined, model2_combined)
```


# Retrieve coefficients from the model output
```{r}
intercept <- fixef(model2_combined)["(Intercept)"]
slope_age <- fixef(model2_combined)["age_scale"]
slope_gender <- fixef(model2_combined)["gender"]
slope_hardship <- fixef(model2_combined)["hardship_index"]
slope_age_hardship <- fixef(model2_combined)["age_scale:hardship_index"]
slope_gender_hardship <- fixef(model2_combined)["gender:hardship_index"]

# Print coefficients for debugging
print(paste("Intercept:", intercept))
print(paste("Slope Age:", slope_age))
print(paste("Slope Gender:", slope_gender))
print(paste("Slope Hardship:", slope_hardship))
print(paste("Slope Age*Hardship:", slope_age_hardship))
print(paste("Slope Gender*Hardship:", slope_gender_hardship))
```

# Plot all countries combined
```{r}
pdf("combined_all_countries.pdf", width = 10, height = 8)  # Adjust width and height as needed

# Plot smoothed scatter without individual data points
smoothScatter(merged_data$age, merged_data$risktaking, las = 1, xaxt = "n", yaxt = "n", 
              xlab = "Age", ylab = "Risk-Taking Propensity", bty = "n", 
              main = "All Countries", cex.main = 0.8, nrpoints = 0, 
              xlim = c(min(merged_data$age, na.rm = TRUE), max(merged_data$age, na.rm = TRUE)), 
              ylim = c(min(merged_data$risktaking, na.rm = TRUE), max(merged_data$risktaking, na.rm = TRUE)), 
              cex.lab = 0.6)

# Add axes and labels
axis(1, at = c(15, 85), labels = c("15", "85"), cex.axis = 0.7, tck = -0.01, line = 0, mgp = c(3, 0.02, 0))
axis(2, at = c(35, 65), labels = c(35, 65), las = 1, cex.axis = 0.7, tck = -0.01, line = 0, mgp = c(3, 0.3, 0))
mtext("Age", 1, line = 0, cex = 0.5)
mtext(expression(Risk~Taking~(italic(T)-score)), 2, line = 1, cex = 0.5)

# Define regression lines
mean_age <- mean(merged_data$age, na.rm = TRUE)
sd_age <- sd(merged_data$age, na.rm = TRUE)  # Calculate the standard deviation of age

# Print debug information for mean and standard deviation of age
print(paste("Mean Age:", mean_age))
print(paste("SD Age:", sd_age))

regline_age <- function(x) {
  intercept + slope_age * ((x - mean_age) / sd_age)
}

regline_gender <- function(x) {
  intercept + slope_gender + slope_age * ((x - mean_age) / sd_age)
}

# Plot regression lines
curve(regline_age(x), from = min(merged_data$age, na.rm = TRUE), to = max(merged_data$age, na.rm = TRUE), add = TRUE, col = "blue", lty = 1, lwd = 3)
curve(regline_gender(x), from = min(merged_data$age, na.rm = TRUE), to = max(merged_data$age, na.rm = TRUE), add = TRUE, col = "green", lty = 2, lwd = 3)

dev.off()
```


# Plot individual countries 
```{r}
# Anzahl der Länder pro Seite und Anzahl der Seiten berechnen
countries_per_page <- 105  # Anzahl der Länder pro Seite
# Extrahiere einzigartige Länder aus dem Datensatz
all_countries <- unique(merged_data$country)
num_pages <- ceiling(length(all_countries) / countries_per_page)  # Anzahl der Seiten berechnen

# Schleife über alle Seiten
for (page in 1:num_pages) {
  # PDF-Datei für die aktuelle Seite erstellen
  pdf(paste0("combined_individual_country", page, ".pdf"), width = 10, height = 8)
  
  # Index der ersten und letzten Länder für die aktuelle Seite berechnen
  start_index <- (page - 1) * countries_per_page + 1
  end_index <- min(start_index + countries_per_page - 1, length(all_countries))
  
  # Länder für die aktuelle Seite extrahieren
  countries_on_page <- all_countries[start_index:end_index]
  
  # Raster von Plots für die aktuelle Seite erstellen
  par(mfrow = c(2, 3))  # 2 Zeilen, 3 Spalten
  
  # Schleife über alle Länder auf der aktuellen Seite
  for (country in countries_on_page) {
    # Daten für das aktuelle Land extrahieren
    data_country <- merged_data[merged_data$country == country, ]
    
    # Koeffizienten des Modells für das aktuelle Land extrahieren
    intercept_country <- fixef(model2_combined, data = data_country)["(Intercept)"]
    slope_age_country <- fixef(model2_combined, data = data_country)["age_scale"]
    slope_gender_country <- fixef(model2_combined, data = data_country)["gender"]
    slope_hardship_country <- fixef(model2_combined, data = data_country)["hardship_index"]
    slope_age_hardship_country <- fixef(model2_combined, data = data_country)["age_scale:hardship_index"]
    slope_gender_hardship_country <- fixef(model2_combined, data = data_country)["gender:hardship_index"]
    
    # Plot für das aktuelle Land erstellen
    smoothScatter(data_country$age, data_country$risktaking, las = 1, xaxt = "n", yaxt = "n", 
                  xlab = "Age", ylab = "Risk-Taking Propensity", bty = "n", 
                  main = country, cex.main = 0.8, nrpoints = 0, 
                  xlim = c(min(data_country$age, na.rm = TRUE), max(data_country$age, na.rm = TRUE)), 
                  ylim = c(min(data_country$risktaking, na.rm = TRUE), max(data_country$risktaking, na.rm = TRUE)), 
                  cex.lab = 0.6)
    
    # Achsen und Beschriftungen hinzufügen
    axis(1, at = c(15, 85), labels = c("15", "85"), cex.axis = 0.7, tck = -0.01, line = 0, mgp = c(3, 0.02, 0))
    axis(2, at = c(35, 65), labels = c(35, 65), las = 1, cex.axis = 0.7, tck = -0.01, line = 0, mgp = c(3, 0.3, 0))
    mtext("Age", 1, line = 0, cex = 0.5)
    mtext(expression(Risk~Taking~(italic(T)-score)), 2, line = 1, cex = 0.5)
    
    # Regression lines für das aktuelle Land definieren
    mean_age_country <- mean(data_country$age, na.rm = TRUE)
    sd_age_country <- sd(data_country$age, na.rm = TRUE)
    
    regline_age_country <- function(x) {
      intercept_country + slope_age_country * ((x - mean_age_country) / sd_age_country)
    }
    
    regline_gender_country <- function(x) {
      intercept_country + slope_gender_country + slope_age_country * ((x - mean_age_country) / sd_age_country)
    }
    
    # Regression lines für das aktuelle Land plotten
    curve(regline_age_country(x), from = min(data_country$age, na.rm = TRUE), to = max(data_country$age, na.rm = TRUE), add = TRUE, col = "blue", lty = 1, lwd = 3)
    curve(regline_gender_country(x), from = min(data_country$age, na.rm = TRUE), to = max(data_country$age, na.rm = TRUE), add = TRUE, col = "green", lty = 2, lwd = 3)
  }
  
  # PDF-Datei schließen
  dev.off()
}

```

