---
title: "4_Hardship_specification_curve_v2"
output: 
  html_document:
    code_folding: hide
date: "2024-05-08"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
rm(list = ls())
```

## Set path Laura: ONLY USE FOR LAURA 
```{r}
# base_path <- "//home.kt.ktzh.ch/B117T23$/Desktop/Riskktaking/Data"
base_path <- "/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/Data_S3"
```

## Library 
```{r}
library(tidyverse)
library(ggplot2)
library(specr)
library(specr)
library(readxl)
library(ggthemes)
library(cowplot)
library(dplyr)
library(knitr)
library(kableExtra)
library(Hmisc)
remotes::install_github("masurp/specr")
library(ggplot2)
library(cowplot)
```

## Load all data
```{r}
# Combined GPS WVS
risktaking <- read.csv(file.path(base_path, "Specification_curve.csv"), header=TRUE, as.is=TRUE)

# Umbenennen von 'isocode' zu 'COUNTRY' in risktaking
risktaking <- risktaking %>%
  rename(COUNTRY = isocode)

risktaking <- risktaking %>%
  select(-hardship_index, -worldmap, -source)

hardship_hs <- read.csv(file.path(base_path, "hardship_HS.csv"))
hardship_finance <- read.csv(file.path(base_path, "hardship_finance.csv"))
hardship_crime <- read.csv(file.path(base_path, "hardship_crime.csv"))
hardship_environment <- read.csv(file.path(base_path, "hardship_environment.csv"))

# Entfernen der nicht benötigten Spalten aus den Datensätzen vor dem Zusammenführen
hardship_hs <- hardship_hs %>%
  select(-country, -avg_risktaking)
hardship_finance <- hardship_finance %>%
  select(-country, -avg_risktaking)
hardship_crime <- hardship_crime %>%
  select(-country, -avg_risktaking)
hardship_environment <- hardship_environment %>%
  select(-country, -avg_risktaking)

# Zusammenführen der Datensätze
hardship_combined <- risktaking %>%
  left_join(hardship_hs, by = "COUNTRY") %>%
  left_join(hardship_finance, by = "COUNTRY") %>%
  left_join(hardship_crime, by = "COUNTRY") %>%
  left_join(hardship_environment, by = "COUNTRY")

#str(hardship_combined)
head(hardship_combined)
```

## Corrlation Heatmap 
```{r}
library(reshape2)

# Auswahl relevanter Spalten
selected_vars <- hardship_combined %>% 
  select(risktaking, "HS_alc_tax_wine", "HS_alc_roaddeath", "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy", "HS_sex_gini",
        "HS_oth_obesity", "HS_oth_cleancooking", "HS_mh_mhhospit", "HS_sex_antiretroviral", "HS_original_lifeexpectancy",
        "HS_original_genderequality",
        "f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int", "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
        "f_original_gdp", "f_original_gini",
        "c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot", "c_bh_parviolenceprog", "c_bh_elderabuse",
        "c_theft_estcorruption", "c_oth_polstab", 
        "e_oth_drinkingwater", "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster",  "e_exp_airdeath100k",
        "e_exp_watersanithyg")

# Berechnung der Korrelationsmatrix für ausgewählte Variablen
cor_matrix <- cor(selected_vars, use = "complete.obs")

# Umwandlung der Korrelationsmatrix in einen Datensatz für ggplot
melted_cor_matrix <- melt(cor_matrix)

# Erstellung der Heatmap mit Korrelationskoeffizienten
library(ggplot2)
ggplot(melted_cor_matrix, aes(Var1, Var2, fill = value)) +
  geom_tile() +  # Zeichnet die Kacheln
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 2.5) +  # Fügt die Korrelationskoeffizienten hinzu
  scale_fill_gradient2(midpoint = 0, low = "blue", high = "red", mid = "white", limit = c(-1,1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8), axis.text.y = element_text(angle = 45, hjust = 1, size = 8)) +
  labs(fill = "Korrelation", x = NULL, y = NULL) +
  coord_fixed()

ggsave("correlation_heatmap.png", width = 12, height = 10, dpi = 300)

```


## Age categories
```{r}
# Neue Alterskategorien definieren
hardship_combined$age_category <- cut(hardship_combined$age,
                                      breaks = c(15, 25, 45, 65, 99),  
                                      labels = c("Young Adults (15-25)", 
                                                 "Adults (26-45)", 
                                                 "Middle-aged Adults (46-65)", 
                                                 "Seniors (66-99)"),
                                      right = TRUE, include.lowest = TRUE)

# Umwandlung der Alterskategorien in numerische Werte
hardship_combined$age_numeric <- as.integer(factor(hardship_combined$age_category))

# Überprüfung der neuen numerischen Alterskategorien
table(hardship_combined$age_category)
```

## Variance of age categories
```{r}
age_variance <- hardship_combined %>%
  group_by(age_category) %>%
  summarise(Varianz = var(age, na.rm = TRUE))

print(age_variance)
```

```{r}
age_sd <- hardship_combined %>%
  group_by(age_category) %>%
  summarise(Standardabweichung = sd(age, na.rm = TRUE))

print(age_sd)
```
```{r}
library(ggplot2)

ggplot(hardship_combined, aes(x = age_category, y = age)) +
  geom_boxplot() +
  labs(title = "Altersverteilung nach Alterskategorie", x = "Age category", y = "Age") +
  theme_minimal()
```

## Aggregate data
```{r}
hardship_combined_agg <- hardship_combined %>%
  group_by(COUNTRY, gender, age_numeric) %>%  # Gruppierung nach Land, Geschlecht, Alter
  summarise(
    risktaking = mean(risktaking, na.rm = TRUE),
    across(starts_with("HS_"), mean, na.rm = TRUE),
    across(starts_with("f_"), mean, na.rm = TRUE),
    across(starts_with("e_"), mean, na.rm = TRUE),
    across(starts_with("c_"), mean, na.rm = TRUE),
    age_scale = mean(age_scale, na.rm = TRUE),
    n = n(),  # Anzahl der Personen pro Gruppe
    .groups = "drop"
  )

hardship_combined_agg <- hardship_combined_agg %>%
  mutate(across(where(is.numeric), ~replace_na(.x, mean(.x, na.rm = TRUE))))
```

## Table with Correlation hardship factors and risktaking 
```{r}
# Laden notwendiger Bibliotheken
library(Hmisc)
library(kableExtra)

# Auswahl aller numerischen Variablen
numeric_vars <- hardship_combined %>%
  select(where(is.numeric))

# Berechnen der Korrelationsmatrix und der p-Werte
cor_results <- rcorr(as.matrix(numeric_vars))

# Korrelationen und p-Werte spezifisch für 'risktaking' extrahieren
correlations <- cor_results$r[, "risktaking"]  # Korrelationen zu 'risktaking'
p_values <- cor_results$P[, "risktaking"]      # p-Werte zu 'risktaking'

# Datenrahmen für die Darstellung erstellen
cor_table <- data.frame(
  Variable = rownames(cor_results$r),  # Namen der Variablen
  Correlation = round(correlations, 5),  # Korrelationswerte, gerundet auf 5 Dezimalstellen
  P_value = format(p_values, scientific = TRUE),  # p-Werte in wissenschaftlicher Notation
  Significant = ifelse(p_values < 0.05, "Yes", "No")  # Signifikanzflag, basierend auf p-Wert
)

# Tabellendarstellung mit 'kable' und 'kableExtra'
cor_table %>%
  kable("html", caption = "Correlations with Risktaking: Summary of Results") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(2, bold = TRUE) %>%
  column_spec(3, background = "lightyellow")
```



# Setup for specifications - all specifications
```{r}
library(specr)

specification <- setup(
  data = hardship_combined,
  y = "risktaking",  # abhängige Variable
  x = c("HS_alc_tax_wine", "HS_alc_roaddeath", "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy", "HS_sex_gini",
        "HS_oth_obesity", "HS_oth_cleancooking", "HS_mh_mhhospit", "HS_sex_antiretroviral", "HS_original_lifeexpectancy",
        "HS_original_genderequality",
        "f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int", "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
        "f_original_gdp", "f_original_gini",
        "c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot", "c_bh_parviolenceprog", "c_bh_elderabuse",
        "c_theft_estcorruption", "c_oth_polstab", 
        "e_oth_drinkingwater", "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster",  "e_exp_airdeath100k",
        "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Zusammenfassung der Spezifikationen
summary(specification)
```
## run specifications
```{r}
specification_results <- specr(specification)
specification_results

summary(specification_results, digits = 5)
```

## summarizing the parameter distribution
```{r}
summary(specification_results, type = "curve")

summary(specification_results, 
        type = "curve", 
        group = "x",           
        stats = c("median", "mean", "min", "max"))  # Statistiken in einem Vektor auflisten
```

## Plots
```{r}
plot(specification_results)

(a <- plot(specification_results, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b <- plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c <- plot(specification_results, type = "samplesizes") + ylim(0, 400))


plot_grid(a, b, c, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```


# Subsetting data for males 
```{r}
specification_males <- setup(
  data = hardship_combined %>%
           filter(gender == 1),  # Filter for males
  y = "risktaking",
  x = c("HS_alc_tax_wine", "HS_alc_roaddeath", "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy", "HS_sex_gini",
        "HS_oth_obesity", "HS_oth_cleancooking", "HS_mh_mhhospit", "HS_sex_antiretroviral", "HS_original_lifeexpectancy",
        "HS_original_genderequality",
        "f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int", "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
        "f_original_gdp", "f_original_gini",
        "c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot", "c_bh_parviolenceprog", "c_bh_elderabuse",
        "c_theft_estcorruption", "c_oth_polstab", 
        "e_oth_drinkingwater", "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster",  "e_exp_airdeath100k",
        "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for males
specification_results_males <- specr(specification_males)

# View the summary of the results
summary(specification_results_males)
```

## Plots for male subset results
```{r}
plot(specification_results_males)

(a_male <- plot(specification_results_males, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_male <- plot(specification_results_males, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_male <- plot(specification_results_males, type = "samplesizes") + ylim(0, 400))


plot_grid(a_male, b_male, c_male, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_males, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```


# Subsetting data for females 
```{r}
specification_females <- setup(
  data = hardship_combined %>%
           filter(gender == 0),  # Filter for females
  y = "risktaking",
  x = c("HS_alc_tax_wine", "HS_alc_roaddeath", "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy", "HS_sex_gini",
        "HS_oth_obesity", "HS_oth_cleancooking", "HS_mh_mhhospit", "HS_sex_antiretroviral", "HS_original_lifeexpectancy",
        "HS_original_genderequality",
        "f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int", "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
        "f_original_gdp", "f_original_gini",
        "c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot", "c_bh_parviolenceprog", "c_bh_elderabuse",
        "c_theft_estcorruption", "c_oth_polstab", 
        "e_oth_drinkingwater", "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster",  "e_exp_airdeath100k",
        "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for females
specification_results_females <- specr(specification_females)

# View the summary of the results
summary(specification_results_females)
```

## Plots for female subset results
```{r}
plot(specification_results_females)

(a_female <- plot(specification_results_females, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_female <- plot(specification_results_females, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_female <- plot(specification_results_females, type = "samplesizes") + ylim(0, 400))


plot_grid(a_female, b_female, c_female, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_females, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

# Subsetting data for age-categories 
```{r}
run_specification_for_age <- function(data, age_id, age_label) {
  # Daten für die spezifische Altersgruppe filtern
  data_subset <- data %>%
    filter(age_numeric == age_id)
  
  # Setup für die Spezifikationen durchführen
  specification <- setup(
    data = data_subset,
    y = "risktaking",
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath", "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy", "HS_sex_gini",
        "HS_oth_obesity", "HS_oth_cleancooking", "HS_mh_mhhospit", "HS_sex_antiretroviral", "HS_original_lifeexpectancy",
        "HS_original_genderequality",
        "f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int", "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
        "f_original_gdp", "f_original_gini",
        "c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot", "c_bh_parviolenceprog", "c_bh_elderabuse",
        "c_theft_estcorruption", "c_oth_polstab", 
        "e_oth_drinkingwater", "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster",  "e_exp_airdeath100k",
        "e_exp_watersanithyg"),
    controls = c("age_scale", "COUNTRY"), 
    model = "lm"
  )

  # Spezifikationsergebnisse berechnen
  specification_results <- specr(specification)

  # Statistische Auswertungen drucken mit Alterskategorie-Titel
  cat("\nStatistische Ergebnisse für die Alterskategorie:", age_label, "\n")
  print(summary(specification_results, digits = 5))

  # Grafiken für die spezifische Altersgruppe erzeugen und anzeigen
  plot_list <- list(
    plot_a = plot(specification_results, type = "curve", ci = FALSE, ribbon = TRUE) + 
             geom_point(size = 4) + ggtitle(paste("Curve Plot -", age_label)),
    plot_b = plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) + 
             geom_point(size = 2, shape = 4) + ggtitle(paste("Choices Plot -", age_label)),
    plot_c = plot(specification_results, type = "samplesizes") + ylim(0, 400) +
             ggtitle(paste("Sample Sizes Plot -", age_label)),
    plot_d = plot(specification_results, type = "boxplot") + 
             geom_point(alpha = .4) + scale_fill_brewer(palette = "Pastel2") + 
             labs(x = "Effect size", fill = "") + ggtitle(paste("Boxplot -", age_label))
  )

  # Rückgabe der Ergebnisse und Plots
  return(list(summary = summary(specification_results, digits = 5), plots = plot_list))
}

# Funktion für jede Altersgruppe aufrufen und sowohl statistische Zusammenfassungen als auch Plots ausgeben
for (i in 1:4) {
  results <- run_specification_for_age(hardship_combined, i, paste("Age Group", i))
  print(results$summary)  # Drucke die Zusammenfassung der Ergebnisse
  print(results$plots$plot_a)
  print(results$plots$plot_b)
  print(results$plots$plot_c)
  print(results$plots$plot_d)
}
```



################################################################################
# Hardship Health/Safety
## Setup for specifications
```{r}
library(dplyr)
library(specr)

# Setup für die Spezifikationen mit einer umfassenderen Auswahl von Variablen
specification <- setup(
  data = hardship_combined,
  y = "risktaking",  # abhängige Variable
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath", 
          "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy",
          "HS_sex_gini", "HS_oth_obesity", "HS_oth_cleancooking",
          "HS_mh_mhhospit", "HS_sex_antiretroviral",
          "HS_original_lifeexpectancy", "HS_original_genderequality"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm", 
  subsets = list(
    male = hardship_combined$gender == 1,  
    female = hardship_combined$gender == 0)
)

# Zusammenfassung der Spezifikationen
summary(specification)
```

```{r}
library(dplyr)
library(specr)

specification <- setup(
  data = hardship_combined_agg,
  y = "risktaking",  # abhängige Variable
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath"),
  controls = c("COUNTRY"), 
  model = "lm", 
  subsets = list(
    male = hardship_combined_agg$gender == 1,  
    female = hardship_combined_agg$gender == 0, 
  age_numeric_youth = hardship_combined_agg$age_numeric == 1)
)

# Zusammenfassung der Spezifikationen
summary(specification)
```


## run specifications
```{r}
specification_results <- specr(specification)
specification_results

summary(specification_results, digits = 5)
```

## summarizing the parameter distribution
```{r}
summary(specification_results, type = "curve")

summary(specification_results, 
        type = "curve", 
        group = "x",           
        stats = c("median", "mean", "min", "max"))  # Statistiken in einem Vektor auflisten
```

## Plots
```{r}
plot(specification_results)

(a <- plot(specification_results, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b <- plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c <- plot(specification_results, type = "samplesizes") + ylim(0, 400))


plot_grid(a, b, c, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2.5, 0.8),
          axis = "rbl")

plot(specification_results, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
library(dplyr)

# Prüfe, ob mehrere Werte pro Kombination existieren
check_counts <- results_df %>%
  count(x, controls)

print(check_counts)  # Sollte für jede Kombination mehr als 1 zeigen

# Falls genügend Werte pro Variable vorhanden sind, berechne die Statistiken korrekt
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Variablen und Kontrollvariablen
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),  # Berechne echten Median
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),  # 25. Perzentil
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),  # 75. Perzentil
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 2)  # Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Zeige die Tabelle an
print(summary_table)
```


## Subsetting data for males 
```{r}
specification_males <- setup(
  data = hardship_combined %>%
           filter(gender == 1),  # Filter for males
  y = "risktaking",
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath", 
          "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy",
          "HS_sex_gini", "HS_oth_obesity", "HS_oth_cleancooking",
          "HS_mh_mhhospit", "HS_sex_antiretroviral",
          "HS_original_lifeexpectancy", "HS_original_genderequality"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for males
specification_results_males <- specr(specification_males)

# View the summary of the results
summary(specification_results_males)
```

## Plots for male subset results
```{r}
plot(specification_results_males)

(a_male <- plot(specification_results_males, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_male <- plot(specification_results_males, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_male <- plot(specification_results_males, type = "samplesizes") + ylim(0, 400))


plot_grid(a_male, b_male, c_male, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_males, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_males$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_HS_male.docx")
```

## Subsetting data for females 
```{r}
specification_females <- setup(
  data = hardship_combined %>%
           filter(gender == 0),  # Filter for females
  y = "risktaking",
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath", 
          "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy",
          "HS_sex_gini", "HS_oth_obesity", "HS_oth_cleancooking",
          "HS_mh_mhhospit", "HS_sex_antiretroviral",
          "HS_original_lifeexpectancy", "HS_original_genderequality"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for females
specification_results_females <- specr(specification_females)

# View the summary of the results
summary(specification_results_females)
```

## Plots for female subset results
```{r}
plot(specification_results_females)

(a_female <- plot(specification_results_females, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_female <- plot(specification_results_females, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_female <- plot(specification_results_females, type = "samplesizes") + ylim(0, 400))


plot_grid(a_female, b_female, c_female, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_females, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```
```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_females$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_HS_female.docx")
```

## Subsetting data for age-categories 
```{r}
run_specification_for_age <- function(data, age_id, age_label) {
  # Daten für die spezifische Altersgruppe filtern
  data_subset <- data %>%
    filter(age_numeric == age_id)
  
  # Setup für die Spezifikationen durchführen
  specification <- setup(
    data = data_subset,
    y = "risktaking",
    x = c("HS_alc_tax_wine", "HS_alc_roaddeath", 
          "HS_drg_treatment", "HS_nic_affordability", "HS_mh_policy",
          "HS_sex_gini", "HS_oth_obesity", "HS_oth_cleancooking",
          "HS_mh_mhhospit", "HS_sex_antiretroviral",
          "HS_original_lifeexpectancy", "HS_original_genderequality"),
    controls = c("age_scale", "COUNTRY"), 
    model = "lm"
  )

  # Spezifikationsergebnisse berechnen
  specification_results <- specr(specification)

  # Statistische Auswertungen drucken mit Alterskategorie-Titel
  cat("\nStatistische Ergebnisse für die Alterskategorie:", age_label, "\n")
  print(summary(specification_results, digits = 5))

  # Grafiken für die spezifische Altersgruppe erzeugen und anzeigen
  plot_list <- list(
    plot_a = plot(specification_results, type = "curve", ci = FALSE, ribbon = TRUE) + 
             geom_point(size = 4) + ggtitle(paste("Curve Plot -", age_label)),
    plot_b = plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) + 
             geom_point(size = 2, shape = 4) + ggtitle(paste("Choices Plot -", age_label)),
    plot_c = plot(specification_results, type = "samplesizes") + ylim(0, 400) +
             ggtitle(paste("Sample Sizes Plot -", age_label)),
    plot_d = plot(specification_results, type = "boxplot") + 
             geom_point(alpha = .4) + scale_fill_brewer(palette = "Pastel2") + 
             labs(x = "Effect size", fill = "") + ggtitle(paste("Boxplot -", age_label))
  )

  # Rückgabe der Ergebnisse und Plots
  return(list(summary = summary(specification_results, digits = 5), plots = plot_list))
}

# Funktion für jede Altersgruppe aufrufen und sowohl statistische Zusammenfassungen als auch Plots ausgeben
for (i in 1:4) {
  results <- run_specification_for_age(hardship_combined, i, paste("Age Group", i))
  print(results$summary)  # Drucke die Zusammenfassung der Ergebnisse
  print(results$plots$plot_a)
  print(results$plots$plot_b)
  print(results$plots$plot_c)
  print(results$plots$plot_d)
}
```

# Hardship Finance
## Setup for specifications
```{r}
library(specr)

# Setup für die Spezifikationen mit einer umfassenderen Auswahl von Variablen
specification <- setup(
  data = hardship_combined,
  y = "risktaking",  # abhängige Variable
    x = c("f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int",
          "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
          "f_original_gdp", "f_original_gini"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Zusammenfassung der Spezifikationen
summary(specification)
```
## run specifications
```{r}
specification_results <- specr(specification)
specification_results

summary(specification_results, digits = 5)
```

## summarizing the parameter distribution
```{r}
summary(specification_results, type = "curve")

summary(specification_results, 
        type = "curve", 
        group = "x",           
        stats = c("median", "mean", "min", "max"))  # Statistiken in einem Vektor auflisten
```

## Plots
```{r}
plot(specification_results)

(a <- plot(specification_results, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b <- plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c <- plot(specification_results, type = "samplesizes") + ylim(0, 400))


plot_grid(a, b, c, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```
```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_f_all.docx")
```


## Subsetting data for males 
```{r}
specification_males <- setup(
  data = hardship_combined %>%
           filter(gender == 1),  # Filter for males
  y = "risktaking",
    x = c("f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int",
          "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
          "f_original_gdp", "f_original_gini"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for males
specification_results_males <- specr(specification_males)

# View the summary of the results
summary(specification_results_males)
```

## Plots for male subset results
```{r}
plot(specification_results_males)

(a_male <- plot(specification_results_males, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_male <- plot(specification_results_males, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_male <- plot(specification_results_males, type = "samplesizes") + ylim(0, 400))


plot_grid(a_male, b_male, c_male, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_males, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_males$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_f_male.docx")
```

## Subsetting data for females 
```{r}
specification_females <- setup(
  data = hardship_combined %>%
           filter(gender == 0),  # Filter for females
  y = "risktaking",
    x = c("f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int",
          "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
          "f_original_gdp", "f_original_gini"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for females
specification_results_females <- specr(specification_females)

# View the summary of the results
summary(specification_results_females)
```

## Plots for female subset results
```{r}
plot(specification_results_females)

(a_female <- plot(specification_results_females, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_female <- plot(specification_results_females, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_female <- plot(specification_results_females, type = "samplesizes") + ylim(0, 400))


plot_grid(a_female, b_female, c_female, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_females, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_females$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_f_female.docx")
```

# Subsetting data for age-categories 
```{r}
run_specification_for_age <- function(data, age_id, age_label) {
  # Daten für die spezifische Altersgruppe filtern
  data_subset <- data %>%
    filter(age_numeric == age_id)
  
  # Setup für die Spezifikationen durchführen
  specification <- setup(
    data = data_subset,
    y = "risktaking",
    x = c("f_inv_acctownership_primaryedu", "f_oth_insfinsvcs_int",
          "f_hs_oopexp10", "f_eco_gdpdefl_linked", "f_eco_cpi",
          "f_original_gdp", "f_original_gini"),
  controls = c("age_scale", "COUNTRY"), 
    model = "lm"
  )

  # Spezifikationsergebnisse berechnen
  specification_results <- specr(specification)

  # Statistische Auswertungen drucken mit Alterskategorie-Titel
  cat("\nStatistische Ergebnisse für die Alterskategorie:", age_label, "\n")
  print(summary(specification_results, digits = 5))

  # Grafiken für die spezifische Altersgruppe erzeugen und anzeigen
  plot_list <- list(
    plot_a = plot(specification_results, type = "curve", ci = FALSE, ribbon = TRUE) + 
             geom_point(size = 4) + ggtitle(paste("Curve Plot -", age_label)),
    plot_b = plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) + 
             geom_point(size = 2, shape = 4) + ggtitle(paste("Choices Plot -", age_label)),
    plot_c = plot(specification_results, type = "samplesizes") + ylim(0, 400) +
             ggtitle(paste("Sample Sizes Plot -", age_label)),
    plot_d = plot(specification_results, type = "boxplot") + 
             geom_point(alpha = .4) + scale_fill_brewer(palette = "Pastel2") + 
             labs(x = "Effect size", fill = "") + ggtitle(paste("Boxplot -", age_label))
  )

  # Rückgabe der Ergebnisse und Plots
  return(list(summary = summary(specification_results, digits = 5), plots = plot_list))
}

# Funktion für jede Altersgruppe aufrufen und sowohl statistische Zusammenfassungen als auch Plots ausgeben
for (i in 1:4) {
  results <- run_specification_for_age(hardship_combined, i, paste("Age Group", i))
  print(results$summary)  # Drucke die Zusammenfassung der Ergebnisse
  print(results$plots$plot_a)
  print(results$plots$plot_b)
  print(results$plots$plot_c)
  print(results$plots$plot_d)
}
```

# Hardship Crime
## Setup for specifications
```{r}
library(specr)

# Setup für die Spezifikationen mit einer umfassenderen Auswahl von Variablen
specification <- setup(
  data = hardship_combined,
  y = "risktaking",  # abhängige Variable
    x = c("c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot",
          "c_bh_parviolenceprog", "c_bh_elderabuse", "c_theft_estcorruption",
          "c_oth_polstab"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Zusammenfassung der Spezifikationen
summary(specification)
```
## run specifications
```{r}
specification_results <- specr(specification)
specification_results

summary(specification_results, digits = 5)
```

## summarizing the parameter distribution
```{r}
summary(specification_results, type = "curve")

summary(specification_results, 
        type = "curve", 
        group = "x",           
        stats = c("median", "mean", "min", "max"))  # Statistiken in einem Vektor auflisten
```

## Plots
```{r}
plot(specification_results)

(a <- plot(specification_results, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b <- plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c <- plot(specification_results, type = "samplesizes") + ylim(0, 400))


plot_grid(a, b, c, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_c_all.docx")
```

## Subsetting data for males 
```{r}
specification_males <- setup(
  data = hardship_combined %>%
           filter(gender == 1),  # Filter for males
  y = "risktaking",
    x = c("c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot",
          "c_bh_parviolenceprog", "c_bh_elderabuse", "c_theft_estcorruption",
          "c_oth_polstab"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for males
specification_results_males <- specr(specification_males)

# View the summary of the results
summary(specification_results_males)
```

## Plots for male subset results
```{r}
plot(specification_results_males)

(a_male <- plot(specification_results_males, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_male <- plot(specification_results_males, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_male <- plot(specification_results_males, type = "samplesizes") + ylim(0, 400))


plot_grid(a_male, b_male, c_male, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_males, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```


```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_males$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_c_male.docx")
```

## Subsetting data for females 
```{r}
specification_females <- setup(
  data = hardship_combined %>%
           filter(gender == 0),  # Filter for females
  y = "risktaking",
    x = c("c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot",
          "c_bh_parviolenceprog", "c_bh_elderabuse", "c_theft_estcorruption",
          "c_oth_polstab"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for females
specification_results_females <- specr(specification_females)

# View the summary of the results
summary(specification_results_females)
```

## Plots for female subset results
```{r}
plot(specification_results_females)

(a_female <- plot(specification_results_females, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_female <- plot(specification_results_females, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_female <- plot(specification_results_females, type = "samplesizes") + ylim(0, 400))


plot_grid(a_female, b_female, c_female, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_females, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_females$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_c_female.docx")
```

# Subsetting data for age-categories 
```{r}
run_specification_for_age <- function(data, age_id, age_label) {
  # Daten für die spezifische Altersgruppe filtern
  data_subset <- data %>%
    filter(age_numeric == age_id)
  
  # Setup für die Spezifikationen durchführen
  specification <- setup(
    data = data_subset,
    y = "risktaking",
    x = c("c_bh_homicide", "c_bh_childmalt", "c_bh_violextchildprot",
          "c_bh_parviolenceprog", "c_bh_elderabuse", "c_theft_estcorruption",
          "c_oth_polstab"),
    controls = c("age_scale", "COUNTRY"), 
    model = "lm"
  )

  # Spezifikationsergebnisse berechnen
  specification_results <- specr(specification)

  # Statistische Auswertungen drucken mit Alterskategorie-Titel
  cat("\nStatistische Ergebnisse für die Alterskategorie:", age_label, "\n")
  print(summary(specification_results, digits = 5))

  # Grafiken für die spezifische Altersgruppe erzeugen und anzeigen
  plot_list <- list(
    plot_a = plot(specification_results, type = "curve", ci = FALSE, ribbon = TRUE) + 
             geom_point(size = 4) + ggtitle(paste("Curve Plot -", age_label)),
    plot_b = plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) + 
             geom_point(size = 2, shape = 4) + ggtitle(paste("Choices Plot -", age_label)),
    plot_c = plot(specification_results, type = "samplesizes") + ylim(0, 400) +
             ggtitle(paste("Sample Sizes Plot -", age_label)),
    plot_d = plot(specification_results, type = "boxplot") + 
             geom_point(alpha = .4) + scale_fill_brewer(palette = "Pastel2") + 
             labs(x = "Effect size", fill = "") + ggtitle(paste("Boxplot -", age_label))
  )

  # Rückgabe der Ergebnisse und Plots
  return(list(summary = summary(specification_results, digits = 5), plots = plot_list))
}

# Funktion für jede Altersgruppe aufrufen und sowohl statistische Zusammenfassungen als auch Plots ausgeben
for (i in 1:4) {
  results <- run_specification_for_age(hardship_combined, i, paste("Age Group", i))
  print(results$summary)  # Drucke die Zusammenfassung der Ergebnisse
  print(results$plots$plot_a)
  print(results$plots$plot_b)
  print(results$plots$plot_c)
  print(results$plots$plot_d)
}
```

# Hardship Environment
## Setup for specifications
```{r}
library(specr)

# Setup für die Spezifikationen mit einer umfassenderen Auswahl von Variablen
specification <- setup(
  data = hardship_combined,
  y = "risktaking",  # abhängige Variable
    x = c("e_oth_drinkingwater",
          "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster", 
          "e_exp_airdeath100k", "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Zusammenfassung der Spezifikationen
summary(specification)
```
## run specifications
```{r}
specification_results <- specr(specification)
specification_results

summary(specification_results, digits = 5)
```

## summarizing the parameter distribution
```{r}
summary(specification_results, type = "curve")

summary(specification_results, 
        type = "curve", 
        group = "x",           
        stats = c("median", "mean", "min", "max"))  # Statistiken in einem Vektor auflisten
```

## Plots
```{r}
plot(specification_results)

(a <- plot(specification_results, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b <- plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c <- plot(specification_results, type = "samplesizes") + ylim(0, 400))


plot_grid(a, b, c, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_e_all.docx")
```

## Subsetting data for males 
```{r}
specification_males <- setup(
  data = hardship_combined %>%
           filter(gender == 1),  # Filter for males
  y = "risktaking",
    x = c("e_oth_drinkingwater",
          "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster", 
          "e_exp_airdeath100k", "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for males
specification_results_males <- specr(specification_males)

# View the summary of the results
summary(specification_results_males)
```

## Plots for male subset results
```{r}
plot(specification_results_males)

(a_male <- plot(specification_results_males, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_male <- plot(specification_results_males, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_male <- plot(specification_results_males, type = "samplesizes") + ylim(0, 400))


plot_grid(a_male, b_male, c_male, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_males, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```

```{r}
# Lade die notwendigen Pakete
library(dplyr)
library(flextable)
library(officer)

# Extrahiere die Ergebnisse aus dem specr-Objekt
results_df <- specification_results_males$data

# Erstelle die Zusammenfassung der Spezifikationsanalyse
summary_table <- results_df %>%
  group_by(x, controls) %>%  # Gruppiere nach Risikofaktor (x) und Kontrollvariablen (controls)
  summarise(
    Median = round(median(estimate, na.rm = TRUE), 5),
    Min = round(min(estimate, na.rm = TRUE), 5),
    Max = round(max(estimate, na.rm = TRUE), 5),
    Q25 = round(quantile(estimate, 0.25, na.rm = TRUE), 5),
    Q75 = round(quantile(estimate, 0.75, na.rm = TRUE), 5),
    Significant_Perc = round(mean(p.value < 0.05, na.rm = TRUE) * 100, 5)  # Prozentualer Anteil signifikanter Werte
  ) %>%
  arrange(desc(Significant_Perc))  # Sortiere nach Signifikanzrate

# Erstelle eine formatierte flextable
summary_flextable <- flextable(summary_table) %>%
  theme_vanilla() %>%  # Optische Gestaltung
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Erstelle ein neues Word-Dokument
doc <- read_docx()

# Füge die Tabelle in das Dokument ein
doc <- body_add_flextable(doc, summary_flextable)

# Speichere das Dokument
print(doc, target = "Specification_Summary_e_male.docx")
```


## Subsetting data for females 
```{r}
specification_females <- setup(
  data = hardship_combined %>%
           filter(gender == 0),  # Filter for females
  y = "risktaking",
    x = c("e_oth_drinkingwater",
          "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster", 
          "e_exp_airdeath100k", "e_exp_watersanithyg"),
  controls = c("age_scale", "COUNTRY"), 
  model = "lm"
)

# Run the specifications for females
specification_results_females <- specr(specification_females)

# View the summary of the results
summary(specification_results_females)
```

## Plots for female subset results
```{r}
plot(specification_results_females)

(a_female <- plot(specification_results_females, type = "curve", ci = F, ribbon = T) + 
   geom_point(size = 4))


(b_female <- plot(specification_results_females, type = "choices", choices = c("x", "y", "model", "controls")) +
   geom_point(size = 2, shape = 4)) 

(c_female <- plot(specification_results_females, type = "samplesizes") + ylim(0, 400))


plot_grid(a_female, b_female, c_female, ncol = 1,
          align = "v",
          rel_heights = c(1.5, 2, 0.8),
          axis = "rbl")

plot(specification_results_females, type = "boxplot") + 
  geom_point(alpha = .4) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(x = "Effect size", fill = "")
```



# Subsetting data for age-categories 
```{r}
run_specification_for_age <- function(data, age_id, age_label) {
  # Daten für die spezifische Altersgruppe filtern
  data_subset <- data %>%
    filter(age_numeric == age_id)
  
  # Setup für die Spezifikationen durchführen
  specification <- setup(
    data = data_subset,
    y = "risktaking",
    x = c("e_oth_drinkingwater",
          "e_exp_watersanithyg100k", "e_ses_gini", "e_ses_school", "e_exp_disaster", 
          "e_exp_airdeath100k", "e_exp_watersanithyg"),
    controls = c("age_scale", "COUNTRY"), 
    model = "lm"
  )

  # Spezifikationsergebnisse berechnen
  specification_results <- specr(specification)

  # Statistische Auswertungen drucken mit Alterskategorie-Titel
  cat("\nStatistische Ergebnisse für die Alterskategorie:", age_label, "\n")
  print(summary(specification_results, digits = 5))

  # Grafiken für die spezifische Altersgruppe erzeugen und anzeigen
  plot_list <- list(
    plot_a = plot(specification_results, type = "curve", ci = FALSE, ribbon = TRUE) + 
             geom_point(size = 4) + ggtitle(paste("Curve Plot -", age_label)),
    plot_b = plot(specification_results, type = "choices", choices = c("x", "y", "model", "controls")) + 
             geom_point(size = 2, shape = 4) + ggtitle(paste("Choices Plot -", age_label)),
    plot_c = plot(specification_results, type = "samplesizes") + ylim(0, 400) +
             ggtitle(paste("Sample Sizes Plot -", age_label)),
    plot_d = plot(specification_results, type = "boxplot") + 
             geom_point(alpha = .4) + scale_fill_brewer(palette = "Pastel2") + 
             labs(x = "Effect size", fill = "") + ggtitle(paste("Boxplot -", age_label))
  )

  # Rückgabe der Ergebnisse und Plots
  return(list(summary = summary(specification_results, digits = 5), plots = plot_list))
}

# Funktion für jede Altersgruppe aufrufen und sowohl statistische Zusammenfassungen als auch Plots ausgeben
for (i in 1:4) {
  results <- run_specification_for_age(hardship_combined, i, paste("Age Group", i))
  print(results$summary)  # Drucke die Zusammenfassung der Ergebnisse
  print(results$plots$plot_a)
  print(results$plots$plot_b)
  print(results$plots$plot_c)
  print(results$plots$plot_d)
}
```
