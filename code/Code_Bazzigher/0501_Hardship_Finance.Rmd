---
title: "4_Hardship_specification_curve_Finance"
output: 
  html_document:
    code_folding: hide
date: "2024-05-08"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
rm(list = ls())
```

# Set path Laura: ONLY USE FOR LAURA 
```{r}
#base_path <- "//home.kt.ktzh.ch/B117T23$/Desktop/Riskktaking/Data"
base_path <- "/Users/laurabazzigher/Documents/GitHub/risk_wvs/data/dataset/Data_S3"
```


#if (!require("devtools")) install.packages("devtools")
#devtools::install_github("aphp/rgho")


# Load libraries
```{r}
library("dplyr")
library("tidyverse")
library("tidyr")
library("WDI")
library(rgho)
```


# Load dataset to create Hardship-Index
```{r}
risktaking <- read.csv(file.path(base_path, "gps_wvs_combined.csv"), header=TRUE, as.is=TRUE)
hardship_Original <- read.csv(file.path(base_path, "countryfacts_cleaned.csv"), header=TRUE, as.is=TRUE)
#view(risktaking)
str(risktaking)
```

# Hardship Countrylist
```{r}
hardship_Finance <- risktaking %>%
  group_by(country, isocode) %>%  # Gruppierung nach Land und ISO-Code
  summarise(
    avg_age = mean(age, na.rm = TRUE),  # Durchschnittsalter, NA-Werte ignorieren
    avg_hardship_index = mean(hardship_index, na.rm = TRUE),  # Durchschnittlicher Hardship-Index
    avg_risktaking = mean(risktaking, na.rm = TRUE),  # Durchschnittliches Risikoverhalten
  ) %>%
  rename(COUNTRY = isocode) %>%  # Umbenennen von 'isocode' zu 'COUNTRY'
  arrange(country)  # Sortieren der Ergebnisse nach Land

hardship_Original <- hardship_Original %>%
  rename(COUNTRY = code) %>%
  select(COUNTRY, homiciderate, gdp, infantmortality, lifeexpectancy, gini, femalemale_primedu, hardship_index)

hardship_Finance <- hardship_Original %>%
  full_join(hardship_Finance, by = "COUNTRY")

# Löschen aller Einträge zu "Serbia and Montenegro"
risktaking <- risktaking %>%
  filter(country != "Serbia and Montenegro")

hardship_Finance <- hardship_Finance %>%
  filter(COUNTRY != "Serbia and Montenegro")

#view(hardship_Finance)
head(hardship_Finance)
```

# Copy and rename original hardship-Variables
```{r}
# Umformen des 'hardship_Original' Datensatzes
hardship_Finance <- hardship_Finance %>%
  mutate(
    HS_original_infantmortality = infantmortality,
    HS_original_lifeexpectancy = lifeexpectancy,
    e_original_gini = gini,
    f_original_gini = gini,
    c_original_homiciderate = homiciderate,
    f_original_gdp = gdp,
    HS_original_genderequality = femalemale_primedu
  )

# Überprüfung der neuen Struktur
str(hardship_Finance)
```

# Naming: 
# Hardship: 
# - Health / Safety (HS), Crime (C), Financial (F), Environmental (E)

# Factor: 
# - HS: Alcohol (alc), Drugs (drg), Nicotine (nic), Mental Health (mh), Sex (sex), Other (oth)
# - C: Bodily harm (bh), Antisocial (anti), Theft/ fraud (theft), Other (oth)
# - F: Gambling (gam), Investment (inv), Other (oth)
# - E: Exposure (exp), Socioeconomic (ses), Other (oth)


# f_oth_grosssaving - Adjusted savings: gross savings (% of GNI)
## Gross savings are the difference between gross national income and public and private consumption... 
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("NY.ADJ.ICTR.GN.ZS") 

# Daten abrufen
f_oth_grosssaving <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_oth_grosssaving <- f_oth_grosssaving %>%
  rename(f_oth_grosssaving = NY.ADJ.ICTR.GN.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_oth_grosssaving <- f_oth_grosssaving %>%
  pivot_wider(names_from = year, values_from = f_oth_grosssaving)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_oth_grosssaving <- f_oth_grosssaving %>%
  mutate(f_oth_grosssaving = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_oth_grosssaving <- f_oth_grosssaving %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_oth_grosssaving <- f_oth_grosssaving %>%
  mutate(f_oth_grosssaving = case_when(
    is.nan(f_oth_grosssaving) ~ NA_real_,
    f_oth_grosssaving == 0 ~ NA_real_,
    TRUE ~ f_oth_grosssaving
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_oth_grosssaving)
```

# f_oth_eduexpenditure - Adjusted savings: education expenditure (% of GNI)
## Education expenditure refers to the current operating expenditures in education, including wages and salaries and excluding capital investments in buildings and equipment.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("NY.ADJ.AEDU.GN.ZS") 

# Daten abrufen
f_oth_eduexpenditure <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_oth_eduexpenditure <- f_oth_eduexpenditure %>%
  rename(f_oth_eduexpenditure = NY.ADJ.AEDU.GN.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_oth_eduexpenditure <- f_oth_eduexpenditure %>%
  pivot_wider(names_from = year, values_from = f_oth_eduexpenditure)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_oth_eduexpenditure <- f_oth_eduexpenditure %>%
  mutate(f_oth_eduexpenditure = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_oth_eduexpenditure <- f_oth_eduexpenditure %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_oth_eduexpenditure <- f_oth_eduexpenditure %>%
  mutate(f_oth_eduexpenditure = case_when(
    is.nan(f_oth_eduexpenditure) ~ NA_real_,
    f_oth_eduexpenditure == 0 ~ NA_real_,
    TRUE ~ f_oth_eduexpenditure
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_oth_eduexpenditure)
```

# f_inv_acctownership_primaryedu - Account ownership at a financial institution or with a mobile-money-service provider, primary education or less (% of population ages 15+)
## Account denotes the percentage of respondents who report having an account (by themselves or together with someone else) at a bank or another type of financial institution or report personally using a mobile money service in the past 12 months (primary education or less, % of population ages 15+).
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("FX.OWN.TOTL.PL.ZS") 

# Daten abrufen
f_inv_acctownership_primaryedu <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_inv_acctownership_primaryedu <- f_inv_acctownership_primaryedu %>%
  rename(f_inv_acctownership_primaryedu = FX.OWN.TOTL.PL.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_inv_acctownership_primaryedu <- f_inv_acctownership_primaryedu %>%
  pivot_wider(names_from = year, values_from = f_inv_acctownership_primaryedu)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_inv_acctownership_primaryedu <- f_inv_acctownership_primaryedu %>%
  mutate(f_inv_acctownership_primaryedu = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_inv_acctownership_primaryedu <- f_inv_acctownership_primaryedu %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_inv_acctownership_primaryedu <- f_inv_acctownership_primaryedu %>%
  mutate(f_inv_acctownership_primaryedu = case_when(
    is.nan(f_inv_acctownership_primaryedu) ~ NA_real_,
    f_inv_acctownership_primaryedu == 0 ~ NA_real_,
    TRUE ~ f_inv_acctownership_primaryedu
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_inv_acctownership_primaryedu)
```

# f_oth_insfinsvcs_exp - Insurance and financial services (% of service exports, BoP)
## Insurance and financial services cover various types of insurance provided to nonresidents by resident insurance enterprises and vice versa, and financial intermediary and auxiliary services (except those of insurance enterprises and pension funds) exchanged between residents and nonresidents.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("BX.GSR.INSF.ZS") 

# Daten abrufen
f_oth_insfinsvcs_exp <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_oth_insfinsvcs_exp <- f_oth_insfinsvcs_exp %>%
  rename(f_oth_insfinsvcs_exp = BX.GSR.INSF.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_oth_insfinsvcs_exp <- f_oth_insfinsvcs_exp %>%
  pivot_wider(names_from = year, values_from = f_oth_insfinsvcs_exp)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_oth_insfinsvcs_exp <- f_oth_insfinsvcs_exp %>%
  mutate(f_oth_insfinsvcs_exp = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_oth_insfinsvcs_exp <- f_oth_insfinsvcs_exp %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_oth_insfinsvcs_exp <- f_oth_insfinsvcs_exp %>%
  mutate(f_oth_insfinsvcs_exp = case_when(
    is.nan(f_oth_insfinsvcs_exp) ~ NA_real_,
    f_oth_insfinsvcs_exp == 0 ~ NA_real_,
    TRUE ~ f_oth_insfinsvcs_exp
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_oth_insfinsvcs_exp)
```


# f_oth_insfinsvcs_int - Insurance and financial services (% of service imports, BoP)
## Insurance and financial services cover various types of insurance provided to nonresidents by resident insurance enterprises and vice versa, and financial intermediary and auxiliary services (except those of insurance enterprises and pension funds) exchanged between residents and nonresidents.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("BM.GSR.INSF.ZS") 

# Daten abrufen
f_oth_insfinsvcs_int <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_oth_insfinsvcs_int <- f_oth_insfinsvcs_int %>%
  rename(f_oth_insfinsvcs_int = BM.GSR.INSF.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_oth_insfinsvcs_int <- f_oth_insfinsvcs_int %>%
  pivot_wider(names_from = year, values_from = f_oth_insfinsvcs_int)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_oth_insfinsvcs_int <- f_oth_insfinsvcs_int %>%
  mutate(f_oth_insfinsvcs_int = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_oth_insfinsvcs_int <- f_oth_insfinsvcs_int %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_oth_insfinsvcs_int <- f_oth_insfinsvcs_int %>%
  mutate(f_oth_insfinsvcs_int = case_when(
    is.nan(f_oth_insfinsvcs_int) ~ NA_real_,
    f_oth_insfinsvcs_int == 0 ~ NA_real_,
    TRUE ~ f_oth_insfinsvcs_int
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_oth_insfinsvcs_int)
```

# f_inv_bankfin_invest - Firms using banks to finance investment (% of firms)
## 	Firms using banks to finance investment are the percentage of firms using banks to finance investments.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("IC.FRM.BNKS.ZS") 

# Daten abrufen
f_inv_bankfin_invest <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_inv_bankfin_invest <- f_inv_bankfin_invest %>%
  rename(f_inv_bankfin_invest = IC.FRM.BNKS.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_inv_bankfin_invest <- f_inv_bankfin_invest %>%
  pivot_wider(names_from = year, values_from = f_inv_bankfin_invest)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_inv_bankfin_invest <- f_inv_bankfin_invest %>%
  mutate(f_inv_bankfin_invest = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_inv_bankfin_invest <- f_inv_bankfin_invest %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_inv_bankfin_invest <- f_inv_bankfin_invest %>%
  mutate(f_inv_bankfin_invest = case_when(
    is.nan(f_inv_bankfin_invest) ~ NA_real_,
    f_inv_bankfin_invest == 0 ~ NA_real_,
    TRUE ~ f_inv_bankfin_invest
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_inv_bankfin_invest)
```


# f_inv_bankfin_workcap - Firms using banks to finance working capital (% of firms)
## 	Firms using banks to finance working capital are the percentage of firms using bank loans to finance working capital.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("IC.FRM.BKWC.ZS") 

# Daten abrufen
f_inv_bankfin_workcap <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_inv_bankfin_workcap <- f_inv_bankfin_workcap %>%
  rename(f_inv_bankfin_workcap = IC.FRM.BKWC.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_inv_bankfin_workcap <- f_inv_bankfin_workcap %>%
  pivot_wider(names_from = year, values_from = f_inv_bankfin_workcap)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_inv_bankfin_workcap <- f_inv_bankfin_workcap %>%
  mutate(f_inv_bankfin_workcap = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_inv_bankfin_workcap <- f_inv_bankfin_workcap %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_inv_bankfin_workcap <- f_inv_bankfin_workcap %>%
  mutate(f_inv_bankfin_workcap = case_when(
    is.nan(f_inv_bankfin_workcap) ~ NA_real_,
    f_inv_bankfin_workcap == 0 ~ NA_real_,
    TRUE ~ f_inv_bankfin_workcap
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_inv_bankfin_workcap)
```


# f_gov_finconsgdp - General Government Final Consumption Expenditure (% of GDP)
## General government final consumption expenditure (formerly general government consumption) includes all government current expenditures for purchases of goods and services (including compensation of employees). It also includes most expenditures on national defense and security, but excludes government military expenditures that are part of government capital formation.
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("NE.CON.GOVT.ZS") 

# Daten abrufen
f_gov_finconsgdp <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_gov_finconsgdp <- f_gov_finconsgdp %>%
  rename(f_gov_finconsgdp = NE.CON.GOVT.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_gov_finconsgdp <- f_gov_finconsgdp %>%
  pivot_wider(names_from = year, values_from = f_gov_finconsgdp)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_gov_finconsgdp <- f_gov_finconsgdp %>%
  mutate(f_gov_finconsgdp = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_gov_finconsgdp <- f_gov_finconsgdp %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_gov_finconsgdp <- f_gov_finconsgdp %>%
  mutate(f_gov_finconsgdp = case_when(
    is.nan(f_gov_finconsgdp) ~ NA_real_,
    f_gov_finconsgdp == 0 ~ NA_real_,
    TRUE ~ f_gov_finconsgdp
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_gov_finconsgdp)


# f_bofp_netfinacct - Net Financial Account (BoP, current US$) 
## The net financial account shows net acquisition and disposal of financial assets and liabilities. It measures how net lending to or borrowing from nonresidents is financed, and is conceptually equal to the sum of the balances on the current and capital accounts. Data are in current U.S. dollars.
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("BN.FIN.TOTL.CD") 

# Daten abrufen
f_bofp_netfinacct <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_bofp_netfinacct <- f_bofp_netfinacct %>%
  rename(f_bofp_netfinacct = BN.FIN.TOTL.CD) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_bofp_netfinacct <- f_bofp_netfinacct %>%
  pivot_wider(names_from = year, values_from = f_bofp_netfinacct)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_bofp_netfinacct <- f_bofp_netfinacct %>%
  mutate(f_bofp_netfinacct = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_bofp_netfinacct <- f_bofp_netfinacct %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_bofp_netfinacct <- f_bofp_netfinacct %>%
  mutate(f_bofp_netfinacct = case_when(
    is.nan(f_bofp_netfinacct) ~ NA_real_,
    f_bofp_netfinacct == 0 ~ NA_real_,
    TRUE ~ f_bofp_netfinacct
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_bofp_netfinacct)


# f_hs_oopexp10 - Proportion of Population Spending More Than 10% of Household Consumption or Income on Out-of-Pocket Health Care Expenditure (%)
## Proportion of population spending more than 10% of household consumption or income on out-of-pocket health care expenditure. Out-of-pocket health expenditure is defined as any spending incurred by a household when any member uses a health good or service to receive any type of care (preventive, curative, rehabilitative, long-term or palliative care); provided by any type of provider; for any type of disease, illness or health condition; in any type of setting (outpatient, inpatient, at home).
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("SH.UHC.OOPC.10.ZS") 

# Daten abrufen
f_hs_oopexp10 <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_hs_oopexp10 <- f_hs_oopexp10 %>%
  rename(f_hs_oopexp10 = SH.UHC.OOPC.10.ZS) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_hs_oopexp10 <- f_hs_oopexp10 %>%
  pivot_wider(names_from = year, values_from = f_hs_oopexp10)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_hs_oopexp10 <- f_hs_oopexp10 %>%
  mutate(f_hs_oopexp10 = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_hs_oopexp10 <- f_hs_oopexp10 %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_hs_oopexp10 <- f_hs_oopexp10 %>%
  mutate(f_hs_oopexp10 = case_when(
    is.nan(f_hs_oopexp10) ~ NA_real_,
    f_hs_oopexp10 == 0 ~ NA_real_,
    TRUE ~ f_hs_oopexp10
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_hs_oopexp10)
```

# f_eco_gdpdefl - Inflation, GDP deflator (annual %)
## 	Inflation as measured by the annual growth rate of the GDP implicit deflator shows the rate of price change in the economy as a whole. The GDP implicit deflator is the ratio of GDP in current local currency to GDP in constant local currency.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("NY.GDP.DEFL.KD.ZG") 

# Daten abrufen
f_eco_gdpdefl <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_eco_gdpdefl <- f_eco_gdpdefl %>%
  rename(f_eco_gdpdefl = NY.GDP.DEFL.KD.ZG) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_eco_gdpdefl <- f_eco_gdpdefl %>%
  pivot_wider(names_from = year, values_from = f_eco_gdpdefl)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_eco_gdpdefl <- f_eco_gdpdefl %>%
  mutate(f_eco_gdpdefl = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_eco_gdpdefl <- f_eco_gdpdefl %>%
  rename(COUNTRY = iso3c)

# Zeige die ersten Zeilen der transformierten Daten
#view(f_eco_gdpdefl)
```

# f_eco_gdpdefl_linked - Inflation, GDP deflator: linked series (annual %)
## Inflation as measured by the annual growth rate of the GDP implicit deflator shows the rate of price change in the economy as a whole. This series has been linked to produce a consistent time series to counteract breaks in series over time due to changes in base years, source data and methodologies. Thus, it may not be comparable with other national accounts series in the database for historical years.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("NY.GDP.DEFL.KD.ZG.AD") 

# Daten abrufen
f_eco_gdpdefl_linked <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_eco_gdpdefl_linked <- f_eco_gdpdefl_linked %>%
  rename(f_eco_gdpdefl_linked = NY.GDP.DEFL.KD.ZG.AD) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_eco_gdpdefl_linked <- f_eco_gdpdefl_linked %>%
  pivot_wider(names_from = year, values_from = f_eco_gdpdefl_linked)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_eco_gdpdefl_linked <- f_eco_gdpdefl_linked %>%
  mutate(f_eco_gdpdefl_linked = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_eco_gdpdefl_linked <- f_eco_gdpdefl_linked %>%
  rename(COUNTRY = iso3c)

# Zeige die ersten Zeilen der transformierten Daten
#view(f_eco_gdpdefl_linked)
```

# f_hs_oopexp10pc - Proportion of population spending more than 10% of household consumption or income on out-of-pocket health care expenditure (%)
## Proportion of population spending more than 10% of household consumption or income on out-of-pocket health care expenditure. Out-of-pocket health expenditure is defined as any spending incurred by a household when any member uses a health good or service to receive any type of care (preventive, curative, rehabilitative, long-term or palliative care); provided by any type of provider; for any type of disease, illness or health condition; in any type of setting (outpatient, inpatient, at home).
```{r}
# Setzen der Länder und Indikatoren
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")  
indicators <- c("SH.UHC.OOPC.10.ZS") 

# Daten abrufen
f_hs_oopexp10pc <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_hs_oopexp10pc <- f_hs_oopexp10pc %>%
  rename(f_hs_oopexp10pc = SH.UHC.OOPC.10.ZS) # Intentional homicides (per 100,000 people)

# Daten transformieren: Jahre als Spalten darstellen
f_hs_oopexp10pc <- f_hs_oopexp10pc %>%
  pivot_wider(names_from = year, values_from = f_hs_oopexp10pc)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_hs_oopexp10pc <- f_hs_oopexp10pc %>%
  mutate(f_hs_oopexp10pc = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_hs_oopexp10pc <- f_hs_oopexp10pc %>%
  rename(COUNTRY = iso3c)

# Werte mit 0 oder NaN durch NA ersetzen
f_hs_oopexp10pc <- f_hs_oopexp10pc %>%
  mutate(f_hs_oopexp10pc = case_when(
    is.nan(f_hs_oopexp10pc) ~ NA_real_,
    f_hs_oopexp10pc == 0 ~ NA_real_,
    TRUE ~ f_hs_oopexp10pc
  ))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_hs_oopexp10pc)
```

# f_hs_oopexp_pov215 - Proportion of population pushed below the $2.15 ($ 2017 PPP) poverty line by out-of-pocket health care expenditure (%)
## This indicator shows the fraction of a country’s population experiencing out-of-pocket health impoverishing expenditures, defined as expenditures without which the household they live in would have been above the $ 2.15 poverty line, but because of the expenditures is below the poverty line. Out-of-pocket health expenditure is defined as any spending incurred by a household when any member uses a health good or service to receive any type of care (preventive, curative, rehabilitative, long-term or palliative care); provided by any type of provider; for any type of disease, illness or health condition; in any type of setting (outpatient, inpatient, at home).
# Setzen der Länder und Indikatoren
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")  
indicators <- c("SH.UHC.NOP1.ZS") 

# Daten abrufen
f_hs_oopexp_pov215 <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_hs_oopexp_pov215 <- f_hs_oopexp_pov215 %>%
  rename(f_hs_oopexp_pov215 = SH.UHC.NOP1.ZS) # Control of Corruption: Estimate

# Daten transformieren: Jahre als Spalten darstellen
f_hs_oopexp_pov215 <- f_hs_oopexp_pov215 %>%
  pivot_wider(names_from = year, values_from = f_hs_oopexp_pov215)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_hs_oopexp_pov215 <- f_hs_oopexp_pov215 %>%
  mutate(f_hs_oopexp_pov215 = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_hs_oopexp_pov215 <- f_hs_oopexp_pov215 %>%
  rename(COUNTRY = iso3c)

# Nur NaN-Werte in NA umwandeln
f_hs_oopexp_pov215 <- f_hs_oopexp_pov215 %>%
  mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))

# Zeige die ersten Zeilen der transformierten Daten
#view(f_hs_oopexp_pov215)
```

# f_eco_cpi - Inflation, consumer prices (annual %)
## Inflation as measured by the consumer price index reflects the annual percentage change in the cost to the average consumer of acquiring a basket of goods and services that may be fixed or changed at specified intervals, such as yearly. The Laspeyres formula is generally used.
```{r}
countries <- c("AFG", "DZA", "AND", "ARG", "ARM", "AUS", "AUT", "AZE", "BGD", "BLR", "BOL", "BIH", "BWA", "BRA", "BGR", "BFA", "KHM", "CMR", "CAN", "CHL", "CHN", "COL", "CRI", "HRV", "CYP", "CZE", "ECU", "EGY", "EST", "ETH", "FIN", "FRA", "GEO", "DEU", "GHA", "GRC", "GTM", "HTI", "HKG", "HUN", "IND", "IDN", "IRN", "IRQ", "ISR", "ITA", "JPN", "JOR", "KAZ", "KEN", "KWT", "KGZ", "LBN", "LBY", "LTU", "MWI", "MYS", "MLI", "MEX", "MDA", "MAR", "NLD", "NZL", "NIC", "NGA", "NOR", "PAK", "PSE", "PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "SAU", "SRB", "SGP", "SVN", "ZAF", "KOR", "ESP", "LKA", "SUR", "SWE", "CHE", "TWN", "TZA", "THA", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VEN", "VNM", "YEM", "ZMB", "ZWE")   
indicators <- c("FP.CPI.TOTL.ZG") 

# Daten abrufen
f_eco_cpi <- WDI(country = countries, indicator = indicators, start = 2005, end = 2014)

# Spalten umbenennen
f_eco_cpi <- f_eco_cpi %>%
  rename(f_eco_cpi = FP.CPI.TOTL.ZG) # Control of Corruption (estimate)

# Daten transformieren: Jahre als Spalten darstellen
f_eco_cpi <- f_eco_cpi %>%
  pivot_wider(names_from = year, values_from = f_eco_cpi)

# Durchschnitt über alle Jahre berechnen und neue Spalte hinzufügen
f_eco_cpi <- f_eco_cpi %>%
  mutate(f_eco_cpi = rowMeans(select(., starts_with("20")), na.rm = TRUE))

# Rename iso3c to COUNTRY
f_eco_cpi <- f_eco_cpi %>%
  rename(COUNTRY = iso3c)

# Nur NaN-Werte in NA umwandeln
f_eco_cpi <- f_eco_cpi %>%
  mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))

# Zeige die ersten Zeilen der transformierten Daten
# view(f_eco_cpi)
```

# Join Specifications to hardship_HS
```{r}
hardship_Finance <- left_join(hardship_Finance, f_oth_grosssaving[, c("COUNTRY", "f_oth_grosssaving")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_oth_eduexpenditure[, c("COUNTRY", "f_oth_eduexpenditure")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_inv_acctownership_primaryedu[, c("COUNTRY", "f_inv_acctownership_primaryedu")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_oth_insfinsvcs_int[, c("COUNTRY", "f_oth_insfinsvcs_int")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_inv_bankfin_invest[, c("COUNTRY", "f_inv_bankfin_invest")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_inv_bankfin_workcap[, c("COUNTRY", "f_inv_bankfin_workcap")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_hs_oopexp10[, c("COUNTRY", "f_hs_oopexp10")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_eco_gdpdefl_linked[, c("COUNTRY", "f_eco_gdpdefl_linked")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_hs_oopexp_pov215[, c("COUNTRY", "f_hs_oopexp_pov215")], by = "COUNTRY")
hardship_Finance <- left_join(hardship_Finance, f_eco_cpi[, c("COUNTRY", "f_eco_cpi")], by = "COUNTRY")

head(hardship_Finance)
```

# Missing Countries
```{r}
# Auswahl aller Spalten, die mit "F_" beginnen
missing_countries <- grep("^f_", names(hardship_Finance), value = TRUE)

# Berechnung des Prozentsatzes der fehlenden Werte pro Land
missing_percentages <- hardship_Finance %>%
  select(country, all_of(missing_countries)) %>%
  group_by(country) %>%
  summarise_each(funs(sum(is.na(.)) / n() * 100), all_of(missing_countries)) %>%
  mutate(average_missing = rowMeans(select(., -country), na.rm = TRUE))  %>%
  arrange(desc(average_missing))  # Sortiert die Daten absteigend nach dem durchschnittlichen Prozentsatz der fehlenden Werte

# Ausgabe der Ergebnisse
print(missing_percentages)
```


```{r}
# Länder RAW und TWN aus dem Datensatz entfernen
hardship_Finance <- hardship_Finance %>%
  filter(!COUNTRY %in% c("TWN", "ADO"))

#str(hardship_Finance)
```

# select variable of hardship_HS
```{r}
hardship_Finance <- hardship_Finance %>% select(COUNTRY, country, avg_risktaking, f_inv_acctownership_primaryedu,  f_oth_insfinsvcs_int, f_inv_bankfin_invest, f_inv_bankfin_workcap, f_hs_oopexp10, f_eco_gdpdefl_linked, f_hs_oopexp_pov215, f_eco_cpi, f_original_gdp, f_original_gini)
str(hardship_Finance)
```

```{r}
library(corrplot)
numeric_vars <- hardship_Finance %>% select(where(is.numeric))
corr_matrix <- cor(numeric_vars, use = "pairwise.complete.obs")
corrplot(corr_matrix, method = "circle")
```



###################################################################

# Prüfung auf den Mechanismus des Fehlens von Daten
```{r}
# Laden des Pakets
library(mice)
```

```{r}
# Fehlende Werte berechnen
missing_percentages <- sapply(hardship_Finance, function(x) {
  sum(is.na(x)) / length(x) * 100
})

# Ergebnisse in DataFrame umwandeln
missing_summary <- data.frame(
  Variable = names(missing_percentages),
  MissingPercentage = missing_percentages
)

# Nach Prozent sortieren
missing_summary <- missing_summary[order(-missing_summary$MissingPercentage), ]

# Ausgabe der Tabelle
print(missing_summary)
```

```{r}
# Installieren des naniar Pakets, falls noch nicht geschehen
if (!require("naniar")) install.packages("naniar")

# Laden des Pakets
library(naniar)

# Durchführung von Little's MCAR-Test (ähnlich)
mcar_test <- naniar::mcar_test(hardship_Finance)

# Ausgabe des Testergebnisses
print(mcar_test)
```


```{r}
library(VIM)

# Aggregierte Missingness-Visualisierung
aggr_plot <- aggr(hardship_Finance, col = c('navyblue', 'red'), numbers = TRUE, sortVars = TRUE, 
                  labels = names(hardship_Finance), cex.axis = 0.7, gap = 3, ylab = c("Missing Data", "Pattern"))

vis_miss(hardship_Finance)
```

```{r}
# Fehlende Werte berechnen
missing_percentages <- sapply(hardship_Finance, function(x) {
  sum(is.na(x)) / length(x) * 100
})

# Ergebnisse in DataFrame umwandeln
missing_summary <- data.frame(
  Variable = names(missing_percentages),
  MissingPercentage = missing_percentages
)

# Nach Prozent sortieren
missing_summary <- missing_summary[order(-missing_summary$MissingPercentage), ]

# Ausgabe der Tabelle
print(missing_summary)
```


```{r}
# Überprüfe, ob alle Variablen tatsächlich numerisch sind
sapply(hardship_Finance, function(x) all(is.numeric(x)))

# Erstelle einen Methoden-Vektor
methods <- rep("none", ncol(hardship_Finance))
names(methods) <- colnames(hardship_Finance)

# Weisen den relevanten Spalten Imputationsmethoden zu
methods["f_original_gini"] <- "pmm"           # Numerisch
methods["f_original_gdp"] <- "pmm"                     # Numerisch
methods["femalemale_primedu"] <- "pmm"       # Numerisch
methods["f_inv_acctownership_primaryedu"] <- "pmm"           # Numerisch
methods["f_oth_insfinsvcs_int"] <- "pmm"   # Numerisch
methods["f_hs_oopexp10"] <- "pmm"              # Numerisch
methods["f_eco_gdpdefl_linked"] <- "pmm"           # Numerisch
methods["f_bofp_netfinacct"] <- "pmm"           # Numerisch
methods["f_inv_bankfin_invest"] <- "pmm"           # Numerisch
methods["f_inv_bankfin_workcap"] <- "pmm"           # Numerisch
```




```{r}
library(mice)

# Auswahl nur der numerischen Spalten
hardship_Finance_numeric <- hardship_Finance %>%
  select(where(is.numeric)) %>%
  select(-avg_risktaking)

# Entfernen von f_hs_oopexp10
hardship_Finance <- hardship_Finance %>% select(-f_inv_bankfin_invest)
hardship_Finance <- hardship_Finance %>% select(-f_inv_bankfin_workcap)
hardship_Finance <- hardship_Finance %>% select(-f_hs_oopexp_pov215)

# Erneute Imputation durchführen
imputed_data <- mice(
  hardship_Finance_numeric,
  m = 20,
  maxit = 50,
  method = "pmm",
  seed = 123
)

completed_data <- complete(imputed_data, 1)

# Zusammenfassung der Imputationsergebnisse
summary(imputed_data)

# Zugriff auf den ersten vollständig imputierten Datensatz
completed_data <- complete(imputed_data, 1)

# Überprüfung der Struktur des vollständigen Datensatzes
str(completed_data)
```

```{r}
imputed_data$imp$f_inv_acctownership_primaryedu  # Zeigt die imputierten Werte für diese Variable
imputed_data$imp$f_oth_insfinsvcs_int  # Zeigt die imputierten Werte für diese Variable
imputed_data$imp$f_hs_oopexp10  # Zeigt die imputierten Werte für diese Variable
imputed_data$imp$f_eco_gdpdefl_linked  # Zeigt die imputierten Werte für diese Variable
imputed_data$imp$f_eco_cpi  # Zeigt die imputierten Werte für diese Variable
imputed_data$imp$f_original_gdp
imputed_data$imp$f_original_gini

# visualisierung
stripplot(imputed_data, pch = 20, cex = 1.2)  # Verteilung der imputierten Werte
densityplot(imputed_data)  # Dichte der imputierten Werte

# Imputierte Daten extrahieren
completed_data <- complete(imputed_data, action = 1)
```




```{r}
# Berechnen der Mittelwerte vor der Imputation
mean_values_pre_imputation <- sapply(hardship_Finance_numeric, mean, na.rm = TRUE)

# Berechnen der Mittelwerte nach der Imputation
mean_values_post_imputation <- sapply(completed_data, mean, na.rm = TRUE)

# Erhalten der Schnittmenge der Namen von Variablen in beiden Datensätzen
common_vars <- intersect(names(mean_values_pre_imputation), names(mean_values_post_imputation))

# Anpassen der Mittelwertdatensätze, um nur gemeinsame Variablen zu enthalten
mean_values_pre_imputation <- mean_values_pre_imputation[common_vars]
mean_values_post_imputation <- mean_values_post_imputation[common_vars]

# Erstellen des Vergleichsdatensatzes
comparison_data <- data.frame(
  Variable = common_vars,
  PreImputation = mean_values_pre_imputation,
  PostImputation = mean_values_post_imputation
)

library(ggplot2)
ggplot(comparison_data, aes(x = Variable, y = PreImputation, fill = "Pre")) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_bar(aes(y = PostImputation, fill = "Post"), stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Vergleich der Mittelwerte vor und nach der Imputation", y = "Mittelwert") +
  scale_fill_manual(values = c("Pre" = "blue", "Post" = "red"))
```


# Füge die imputierten Variablen zurück in den ursprünglichen Datensatz ein:
```{r}
hardship_Finance <- hardship_Finance %>%
  mutate(
    f_inv_acctownership_primaryedu = completed_data$f_inv_acctownership_primaryedu,
    f_oth_insfinsvcs_int = completed_data$f_oth_insfinsvcs_int,
    f_hs_oopexp10 = completed_data$f_hs_oopexp10,
    f_eco_gdpdefl_linked = completed_data$f_eco_gdpdefl_linked,
    f_eco_cpi = completed_data$f_eco_cpi,
    f_original_gdp = completed_data$f_original_gdp,
    f_original_gini = completed_data$f_original_gini
  )

# Überprüfung der Struktur des aktualisierten Datensatzes
str(hardship_Finance)
```


```{r}
# Überprüfe, ob es noch fehlende Werte in den relevanten Variablen gibt
sum(is.na(hardship_Finance$f_inv_acctownership_primaryedu))  # Soll 0 ergeben
sum(is.na(hardship_Finance$f_oth_insfinsvcs_int))  # Soll 0 ergeben
sum(is.na(hardship_Finance$f_hs_oopexp10))  # Soll 0 ergeben
sum(is.na(hardship_Finance$f_eco_gdpdefl_linked))  # Soll 0 ergeben
sum(is.na(hardship_Finance$f_eco_cpi))  # Soll 0 ergeben
```

## check countryfacts 
```{r}
# Plot histograms for each numeric variable
hardship_Finance %>% 
  select_if(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
  facet_wrap(~key, scales = "free") + 
  geom_histogram(bins = 30) + 
  theme_minimal()
```
# Ausreisser
```{r}
# Winsorisierung nur auf Variablen mit potenziellen Ausreißern
winsorize <- function(x, lower_quantile = 0.01, upper_quantile = 0.99) {
  lower <- quantile(x, lower_quantile, na.rm = TRUE)
  upper <- quantile(x, upper_quantile, na.rm = TRUE)
  pmin(pmax(x, lower), upper)
}

hardship_Finance <- hardship_Finance %>%
  mutate(f_hs_oopexp10 = winsorize(f_hs_oopexp10)
  )

# 3. Keine Anpassung für andere Variablen (z. B. E_oth_safewater)
# Überprüfen der Struktur nach Transformationen
#view(hardship_Finance)
```



## Log Countryfacts 
```{r}
# Log-transform the variables using dplyr
hardship_Finance <- hardship_Finance %>%
  mutate(
    f_inv_acctownership_primaryedu = log(f_inv_acctownership_primaryedu),
    f_oth_insfinsvcs_int = log(f_oth_insfinsvcs_int),
    f_hs_oopexp10 = log(f_hs_oopexp10),
    f_eco_gdpdefl_linked = log(f_eco_gdpdefl_linked),
    f_eco_cpi = log(f_eco_cpi)

  )

head(hardship_Finance)

# Plot histograms for each numeric variable
hardship_Finance %>% 
  select_if(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) + 
  facet_wrap(~key, scales = "free") + 
  geom_histogram(bins = 30) + 
  theme_minimal()
```

## Reverse Coding - Standardize and create hardship_HS
```{r}
library(dplyr)

# Skalieren und ggf. Invertieren der Variablen
hardship_Finance <- hardship_Finance %>%
  mutate(
    f_inv_acctownership_primaryedu = scale(-f_inv_acctownership_primaryedu), # reverse coding
    f_oth_insfinsvcs_int = scale(-f_oth_insfinsvcs_int), # reverse coding
    f_hs_oopexp10 = scale(-f_hs_oopexp10), # reverse coding
    f_eco_gdpdefl_linked = scale(f_eco_gdpdefl_linked), # keine Umkehrung
    f_eco_cpi = scale(f_eco_cpi) # keine Umkehrung
  ) %>%
  rowwise() %>%
  mutate(
    hardship_Finance_index = mean(c(f_inv_acctownership_primaryedu, f_oth_insfinsvcs_int, f_hs_oopexp10, f_eco_gdpdefl_linked, f_eco_cpi, f_original_gdp, f_original_gini), na.rm = TRUE)
  ) %>%
  ungroup()

# Überprüfung des aktualisierten Datensatzes
# View the updated hardship_Finance data frame
head(hardship_Finance)
```

# Correlation Heatmap with all variables 
```{r}
# Erstellung der Heatmap mit Korrelationskoeffizienten
library(ggplot2)
library(reshape2)

# Berechnung der Korrelationsmatrix
cor_matrix <- cor(hardship_Finance %>% select_if(is.numeric), use = "complete.obs")

# Umwandlung der Korrelationsmatrix in einen Datensatz für ggplot
melted_cor_matrix <- melt(cor_matrix)

# Erstellen der Heatmap mit Korrelationskoeffizienten
ggplot(melted_cor_matrix, aes(Var1, Var2, fill = value)) +
  geom_tile() +  # Zeichnet die Kacheln
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  # Fügt die Korrelationskoeffizienten hinzu
  scale_fill_gradient2(midpoint = 0, low = "blue", high = "red", mid = "white", limit = c(-1,1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Korrelation", x = NULL, y = NULL) +
  coord_fixed()

# Optional: Speichern der Heatmap als PDF
ggsave("correlation_heatmap.pdf", width = 11, height = 9, path = base_path)
```

# Corrlation Heatmap with Health/Safety-Hardship
```{r}
# Auswahl relevanter Spalten
selected_vars <- hardship_Finance %>% 
  select(avg_risktaking, starts_with("f_"))

# Berechnung der Korrelationsmatrix für ausgewählte Variablen
cor_matrix <- cor(selected_vars, use = "complete.obs")

# Umwandlung der Korrelationsmatrix in einen Datensatz für ggplot
melted_cor_matrix <- melt(cor_matrix)

# Erstellung der Heatmap mit Korrelationskoeffizienten
library(ggplot2)
ggplot(melted_cor_matrix, aes(Var1, Var2, fill = value)) +
  geom_tile() +  # Zeichnet die Kacheln
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  # Fügt die Korrelationskoeffizienten hinzu
  scale_fill_gradient2(midpoint = 0, low = "blue", high = "red", mid = "white", limit = c(-1,1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Korrelation", x = NULL, y = NULL) +
  coord_fixed()
```



# Cronbachs Alpha
```{r}
library(psych)

# Sicherstellen, dass alle relevanten 'f_'-Spalten ausgewählt werden
items <- hardship_Finance %>%
  select(f_inv_acctownership_primaryedu, f_oth_insfinsvcs_int, f_hs_oopexp10, f_eco_gdpdefl_linked, f_eco_cpi, f_original_gdp, f_original_gini)

# Berechnung von Cronbachs Alpha
alpha_result <- alpha(items)
print(alpha_result)
```

```{r}
write.csv(hardship_Finance, file = file.path(base_path, "hardship_finance.csv"), row.names = FALSE)
```









